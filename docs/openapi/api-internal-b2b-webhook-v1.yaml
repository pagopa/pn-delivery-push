# di seguito le variabili che possono subire variazioni in caso di modifiche all'applicazione, da ricercare in base all'ID
# <span id="webhookMaxLength">10</span> pn.delivery-push.webhook.max-length = lunghezza massima della response degli eventi
# <span id="webhookMaxStreams">5</span> pn.delivery-push.webhook.max-streams = numero massimo di stram confgurabili per PA
# <span id="webhookTtl">7</span> pn.delivery-push.webhook.ttl = retention per gli eventi webhook PN-2264
openapi: 3.0.3
info:
  termsOfService: https://notifichedigitali.pagopa.it/pubbliche-amministrazioni/index.html
  title: 'Piattaforma Notifiche: API B2B avanzamento notifiche'
  x-summary: 'API B2B avanzamento notifiche'
  version: '1.0.0'
  x-api-id: api-internal-b2b-webhook # NO EXTERNAL
#  x-api-id: api-external-b2b-webhook # ONLY EXTERNAL
  description: >- 
    I mittenti di notifica possono seguire il flusso di avanzamento delle notifiche in modo 
    automatico. E' possibile definire fino ad un <font color="red"><strong>massimo di <span id="webhookMaxStreams">5</span> configurazioni di flussi</strong></font> per 
    informazioni relative a: <br/>
      - cambiamento di stato della notifica;  <br/>
      - inserimento di elementi nella timeline. <br/>
    
    Per ognuno di questi elementi è possibile definire un filtro per ricevere solo alcuni 
    cambiamenti di stato o determinati eventi di timeline di maggiore interesse. Si consiglia 
    di creare gli stream prima dell'invio delle notifiche perchè gli stati o gli eventi di 
    timeline vengono registrati solo successivamente alla creazione dello stream.</br>
    </br>
    __Esempio:__
    - Stream contenente tutte le notifiche in stato Cancellato:
    </br></br>
    ``
    {
      "title": "NotificationCancelled",
      "eventType": "STATUS",
      "filterValues": [
        "CANCELLED"
      ]
    }
    ``
    </br></br>
    __Esempio:__
    - Stream contenente tutte le notifiche in stato Accettato o Consegnato:
    </br></br>
    ``
    {
      "title": "NotificationAcceptedOrDelivered",
      "eventType": "STATUS",
      "filterValues": [
        "ACCEPTED","DELIVERED"
      ]
    }
    ``
    </br></br>
    __Esempio:__
    - Stream contenente tutti gli eventi di timeline NOTIFICATION_VIEWED:
    </br></br>
    ``
    {
      "title": "TimelineNotificationViewed",
      "eventType": "TIMELINE",
      "filterValues": [
        "NOTIFICATION_VIEWED"
      ]
    }
    ``
    </br></br>
    
    Gli stati della notifica sono i seguenti: 
      <details>
        <summary>Stati</summary>
        <ul>
          <li><strong>IN_VALIDATION </strong><em>notifica depositata in attesa di validazione.</em></li>
          <li><strong>ACCEPTED </strong><em>L'ente ha depositato la notifica con successo.</em></li>
          <li><strong>REFUSED </strong><em>Notifica rifiutata a seguito della validazione.</em></li>
          <li><strong>DELIVERING </strong><em>L'invio della notifica è in corso.</em></li>
          <li><strong>DELIVERED </strong><em>La notifica è stata consegnata a tutti i destinatari.</em></li>
          <li><strong>VIEWED </strong><em>Il destinatario ha letto la notifica entro il termine stabilito.</em></li>
          <li><strong>EFFECTIVE_DATE </strong><em>Il destinatario non ha letto la notifica entro il termine stabilito.</em></li>
          <li><strong>PAID </strong><em>Uno dei destinatari ha pagato la notifica.</em></li>
          <li><strong>UNREACHABLE </strong><em>Il destinatario non è reperibile.</em></li>
          <li><strong>CANCELLED </strong><em>L'ente ha annullato l'invio della notifica.</em></li>
        </ul>
      </details>
    </br>

    Le categorie degli eventi di timeline sono i seguenti: 

      <details>
        <summary>Eventi di timeline</summary>
        <ul>
          <li><strong>REQUEST_REFUSED </strong><em>Richiesta di notifica rifiutata per fallimento di validazione.</em></li>
          <li><strong>REQUEST_ACCEPTED </strong><em>Richiesta di notifica accettata a seguito dei controlli di validazione.</em></li>
          <li><strong>SEND_COURTESY_MESSAGE </strong><em>Invio di un messaggio di cortesia.</em></li>
          <li><strong>PUBLIC_REGISTRY_CALL </strong><em>Richiesta ai registri pubblici per ottenere domicilio digitale generale o per ottenere indirizzo fisico da ANPR, da registro della imprese, da anagrafe tributaria.</em></li>
          <li><strong>PUBLIC_REGISTRY_RESPONSE </strong><em>Ricevuta la risposta dei registri pubblici.</em></li>
          <li><strong>GET_ADDRESS </strong><em>Disponibilità dell’indirizzo specifico (domicilio digitale di piattaforma, domicilio digitale speciale, domicilio digitale generale, indirizzo fisico sulla notifica o sui registri nazionali).</em></li>
          <li><strong>SCHEDULE_ANALOG_WORKFLOW </strong><em>Inizio del workflow per invio cartaceo.</em></li>
          <li><strong>SCHEDULE_DIGITAL_WORKFLOW </strong><em>Inizio il workflow per invio digitale (PEC).</em></li>
          <li><strong>SEND_DIGITAL_DOMICILE </strong><em>Invio digitale dell’avviso di notifica</em></li>
          <li><strong>SEND_DIGITAL_FEEDBACK </strong><em>Ottenuto esito ad un invio digitale</em></li>
          <li><strong>SCHEDULE_REFINEMENT </strong><em>Pianificato il perfezionamento per decorrenza termini</em></li>
          <li><strong>REFINEMENT </strong><em>Perfezionamento per decorrenza termini</em></li>
          <li><strong>DIGITAL_SUCCESS_WORKFLOW </strong><em>Completato con successo il workflow di invio digitale.</em></li>
          <li><strong>DIGITAL_FAILURE_WORKFLOW </strong><em>Completato con fallimento il workflow di invio digitale. <strong>NOTA</strong>: in caso di DIGITAL_FAILURE_WORKFLOW piattaforma notifiche invia la AAR (Avviso di Avvenuta Ricezione) tramite raccomandata semplice e la notifica si considera consegnata.</em></li>
          <li><strong>ANALOG_SUCCESS_WORKFLOW </strong><em>Completato con successo il workflow di invio cartaceo.</em></li>
          <li><strong>ANALOG_FAILURE_WORKFLOW </strong><em>Completato con fallimento il workflow di invio cartaceo. <strong>NOTA</strong>: se per tutti i destinatari si conclude il workflow con fallimento verrà scatenato l’evento COMPLETELY_UNREACHABLE</em></li>
          <li><strong>SEND_SIMPLE_REGISTERED_LETTER </strong><em>Invio di raccomandata semplice</em></li>
          <li><strong>NOTIFICATION_VIEWED </strong><em>Perfezionamento per presa visione</em></li>
          <li><strong>SEND_ANALOG_DOMICILE </strong><em>Invio cartaceo dell’avviso di notifica</em></li>
          <li><strong>SEND_PAPER_FEEDBACK </strong><em>Ricezione esito dell'invio cartaceo</em></li>
          <li><strong>COMPLETELY_UNREACHABLE </strong><em>Tutti i destinatari risultano irraggiungibili</em></li>
          <li><strong>AAR_GENERATION </strong><em>Generazione dell’AAR (Avviso di Avvenuta Ricezione)</em></li>
          <li><strong>PAYMENT </strong><em>Ricezione pagamento della notifica</em></li>
          <li><strong>NOT_HANDLED </strong><em>Per la sperimentazione l'invio analogico non è previsto, viene inserito tale elemento di timeline</em></li>
        </ul>
      </details>
    </br>

    Le operazioni con il tag __Streams__ gestiscono la configurazione: <br/>
      - [Creazione](#/Streams/createEventStream) <br/>
      - [Elencare la lista degli stream creati](#/Streams/listEventStreams) <br/>
      - [Leggere i metadati dello stream](#/Streams/getEventStream) <br/>
      - [Modifica](#/Streams/updateEventStream) <br/>
      - [Cancellazione](#/Streams/deleteEventStream) <br/>

    Le operazioni con il tag __Events__ sono quelle utilizzate per la [lettura degli eventi](#/Events/consumeEventStream) 
    filtrati in base alla configurazione impostata negli streams.
    
    La api restituisce un massimo di <span id="webhookMaxLength">10</span> elementi. Se <u>esistono</u> ulteriori eventi nello stream, allora la response del servizio 
    restituice l'elemento `retryAfter = 0`; ed è quindi possibile richiamare immediatamente il servizio per ottenere gli eventi successivi, utilizzando 
    il parametro _lastEventId_ valorizzato con l'ultimo _eventId_ della richiesta precedente.
    Si evidenzia che ogni nuova chiamata al servizio con _lastEventId_ implica la cancellazione degli eventi precedenti.
    Tuttavia, in fase di implementazione del client che consumerà i servizi, bisogna considerare il fattore della __non univocità degli eventi__: è possibile che
    se in un dato secondo avvengano più eventi contemporaneamente, nella chiamata successiva allo stream dove si inserisce l'_eventId_, non vengano cancellati
    gli altri eventi contemporanei avvenuti nello stesso secondo dell'_eventId_ indicato; ottenendo quindi una riproposizione di eventi già ottenuti dalla chiamata precedente.</br>
    Se <u>non esistono</u> ulteriori eventi nello stream, allora la response del servizio restituisce il valore di `retryAfter ≠ 0` ed è quindi necessario attendere il tempo indicato dalla retryAfter per consumare eventualmente nuovi eventi nello stream.</br>
    <font color="red">__Gli eventi sono mantenuti per un massimo di <span id="webhookTtl">7</span> giorni dopo i quali sono automaticamente cancellati anche se non sono stati prelevati dallo stream, e sarà possibile ottenere lo stato della notifica solo attraverso il servizio [getNotificationRequestStatus](https://petstore.swagger.io/?url=https://raw.githubusercontent.com/pagopa/pn-delivery/develop/docs/openapi/api-external-b2b-pa-v1.yaml#/SenderReadB2B/retrieveNotificationRequestStatus)__ </font> 

    </br>
    </br>
    </br>

    <details>
      <summary><strong><big><big><big><big>FAQ</big></big></big></big></strong></summary>

      ><details>
      <summary><strong>Cosa devo fare se ricevo</strong> `{"message": "Unauthorized"}`<strong>?</strong></summary>
      <em>Il messaggio indica che non sono disponibili le credenziali per utilizzare i servizi di PN. Per intraprendere il processo di accreditamento, occorre contattare il personale preposto su [account@pagopa.it](mailto:account@pagopa.it)</em>
      </details>

      ><details>
      <summary><strong>Se creo uno stream senza filtri ad esempio</strong></br>`{ "title": "NoFilteredStream", "eventType": "STATUS", "filterValues": [] }`</br><strong> questo raccoglierà tutti i cambi di stato avvenuti nel tempo?</strong></summary>
      <em>SI. Questo concetto è valido anche per gli eventi di TIMELINE.</em>
      </details>

      ><details>
      <summary><strong>E' meglio avere più stream filtrati, per inquadrare specifici eventi di interesse?</strong></summary>
      <em>SI, è consigliato generare uno o più stream applicando i filtri sugli eventi di status / timeline di maggior interesse, 
      <font color="red"><strong>restando nel limite massimo di <span id="webhookMaxStreams">5</span> 
      stream per PA.</font></strong></em>
      </details>      

      ><details>
      <summary><strong>Dopo aver creato uno stream ed inserite alcune notifiche, come posso vedere gli eventi da esse generati?</strong></summary>
      <em>Per ottenere gli eventi bisogna chiamare il servizio per la [lettura degli eventi](#/Events/consumeEventStream) inserendo nel path variabile lo _streamId_ dello stream che si vuole interrogare. A questo punto:</br>
      >><strong>1) </strong>Se nell'header della response ottengo <strong>retry-after = 0</strong> significa che è possibile consumare ulteriori eventi presenti nello stream;</br> quindi, per ottenere gli eventi successivi dovrò richiamare nuovamente lo stesso servizio, aggiungendo come query param l'<strong>eventId</strong> dell'ultimo evento.</br></br>
      <strong>2) </strong>Se nell'header della response ottengo <strong>retryAfter ≠ 0</strong> ed ho eventi nel body della response, significa che lo stream non contiene altri eventi e sarà necessario</br> attendere che ne siano generati di nuovi, prima di poter richiamare di nuovamente il servizio sullo stesso stream.</em></br></br>
      </details>      

      ><details>
      <summary><strong>Posso ottenere più di <span id="webhookMaxLength">10</span> eventi da una singola chiamata?</strong></summary>
      <em>NO, questo valore è configurato pari a <span id="webhookMaxLength">10</span> a livello applicativo e non può essere modificato.</em>
      </details> 

      ><details>
      <summary><strong>Ho interrogato uno stream inserendo come path variabile lo _streamId_ di mio interesse ed ho ottenuto <span id="webhookMaxLength">10</span> eventi, ognuno con il proprio _eventId_. Ho richiamato di nuovo lo stesso servizio aggiungendo come query param l'_eventId_ dell'ultimo evento ottenuto nella prima chiamata ed ottengo gli eventi successivi a quelli ottenuti nella prima chiamata. Posso vedere di nuovo gli eventi ottenuti dalla prima chiamata?</strong></summary>
      <em>NO, una volta passato il query param __eventId__ alla chiamata del servizio, tutti gli eventi precedenti sono cancellati dallo stream e non possono più essere recuperati. E' quindi fondamentale salvare gli eventi ottenuti da ogni chiamata, prima di richiedere i successivi.</em></br></br>
      </details> 

      ><details><summary><strong>Per quanto tempo gli eventi restano registrati su uno stream?</strong></summary><em>Gli eventi restano registrati su uno stream per <strong><span id="webhookTtl">7</span> 
      giorni</strong>, trascorsi i quali non potranno più essere recuperati. A questo punto sarà possibile ottenere lo stato della notifica solo attraverso il servizio puntuale [getNotificationRequestStatus](https://petstore.swagger.io/?url=https://raw.githubusercontent.com/pagopa/pn-delivery/develop/docs/openapi/api-external-b2b-pa-v1.yaml#/SenderReadB2B/retrieveNotificationRequestStatus), mentre se si conosce lo IUN si può utilizzare il servizio [getSentNotification](https://petstore.swagger.io/?url=https://raw.githubusercontent.com/pagopa/pn-delivery/develop/docs/openapi/api-external-b2b-pa-v1.yaml#/SenderReadB2B/retrieveSentNotification) per leggere tutti i dettagli di una notifica accettata</em></details>

    </details>

    

  contact:
    email: pn-supporto-enti@pagopa.it
  license:
    name: Licenza di PN
    url: 'https://notifichedigitali.pagopa.it/pubbliche-amministrazioni/index.html'
servers:
- url: https://api.pn.pagopa.it
  description: Ambiente di produzione
- url: https://api.uat.pn.pagopa.it
  description: Ambiente di test
- url: https://api.dev.pn.pagopa.it
  description: Ambiente di sviluppo
tags:
  - name: HealthCheck
    description: >-
      Invocazioni per sapere lo stato del microservizio
  - name: Streams
    description: >-
      Gestione degli stream di eventi che PN mette a disposizione
  - name: Events
    description: Metodi per la lettura degli eventi dagli stream
paths:
  '/status':
    get:
      summary: healthCheck path
      description: healtCheck path per verificare lo stato del microservizio
      tags:
        - HealthCheck
      operationId: status
      responses:
        '200':
          description: Ok
        '500':
          description: Internal Server Error
    ############################################################################################
    ###                        CREAZIONE E CANCELLAZIONE STREAM EVENTI                       ###
    ############################################################################################

  '/delivery-progresses/streams':
    parameters:                                               # NO EXTERNAL
      - $ref: '#/components/parameters/uidAuthFleet'          # NO EXTERNAL
      - $ref: '#/components/parameters/cxTypeAuthFleet'       # NO EXTERNAL
      - $ref: '#/components/parameters/cxIdAuthFleet'         # NO EXTERNAL
    post:
      summary: Crea nuovo stream di eventi
      description: >-
        Viene richiesta la creazione di un flusso di eventi specificando se gli eventi saranno 
        relativi ai cambi di stato o agli eventi di timeline. <br/>
        In risposta, Piattaforma Notifiche, comunicherà un identificativo dello stream e il 
        timestamp di effettiva attivazione del flusso, tipicamente pochi secondi dopo che è stata 
        invocata l'operazione.
      tags:
        - Streams
      operationId: createEventStream
      requestBody:
        required: true
        content:
          application/json:
              schema:
                $ref: "#/components/schemas/StreamCreationRequest"
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StreamMetadataResponse"
        '400':
          description: Invalid input
          content:
            application/problem+json:
              schema:
                $ref: 'remote-refs.yaml#/components/schemas/Problem'
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: 'remote-refs.yaml#/components/schemas/Problem'
    get:
      summary: Elenca stream di eventi
      description: >-
        Elenca gli stream di eventi
      tags:
        - Streams
      operationId: listEventStreams
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StreamListResponse"
        '400':
          description: Invalid input
          content:
            application/problem+json:
              schema:
                $ref: 'remote-refs.yaml#/components/schemas/Problem'
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: 'remote-refs.yaml#/components/schemas/Problem'

  '/delivery-progresses/streams/{streamId}':
    parameters:
      - $ref: '#/components/parameters/uidAuthFleet'          # NO EXTERNAL
      - $ref: '#/components/parameters/cxTypeAuthFleet'       # NO EXTERNAL
      - $ref: '#/components/parameters/cxIdAuthFleet'         # NO EXTERNAL
      - $ref: '#/components/parameters/pathStreamId'        
    get:
      summary: Leggi metadati dello stream
      description: >-
        Permette di leggere le configurazioni di uno stream di eventi.
      tags:
        - Streams
      operationId: getEventStream                             # NO EXTERNAL
#      operationId: retrieveEventStream                       # ONLY EXTERNAL
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StreamMetadataResponse"
        '400':
          description: Invalid input
          content:
            application/problem+json:
              schema:
                $ref: 'remote-refs.yaml#/components/schemas/Problem'
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: 'remote-refs.yaml#/components/schemas/Problem'
    put:
      summary: Update Stream metadata
      description: >-
        Permette di cambiare le configurazioni dei filtri associati a uno stream di eventi
      tags:
        - Streams
      operationId: updateEventStream
      requestBody:
        required: true
        content:
          application/json:
              schema:
                $ref: "#/components/schemas/StreamCreationRequest"
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StreamMetadataResponse"
        '400':
          description: Invalid input
          content:
            application/problem+json:
              schema:
                $ref: 'remote-refs.yaml#/components/schemas/Problem'
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: 'remote-refs.yaml#/components/schemas/Problem'
    delete:
      summary: Remove Event Stream
      description: >-
        Elimina uno steam di eventi: elimina sia le configurazioni sia tutti gli eventi 
        associati allo stream e non ancora consumati.
      tags:
        - Streams
      operationId: deleteEventStream                          # NO EXTERNAL
#      operationId: removeEventStream                         # ONLY EXTERNAL
      responses:
        '204':
          description: OK
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: './remote-refs.yaml#/components/schemas/Problem'
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: 'remote-refs.yaml#/components/schemas/Problem'


    ############################################################################################
    ###                             LETTURA EVENTI DA UNO STREAM                             ###
    ############################################################################################

  '/delivery-progresses/streams/{streamId}/events':
    get:
      summary: Leggi progressi notifiche
      description: >-
        Permette di leggere gli eventi presenti nello stream di aggiornamenti e indica che 
        la P.A. ha ricevuto e memorizzato l'evento identificato dal parametro _lastEventId_
        e tutti gli eventi precedenti. Tali eventi potranno essere cancellati dallo stream.
      tags:
        - Events
      operationId: consumeEventStream
      parameters:
        - $ref: '#/components/parameters/uidAuthFleet'          # NO EXTERNAL
        - $ref: '#/components/parameters/cxTypeAuthFleet'       # NO EXTERNAL
        - $ref: '#/components/parameters/cxIdAuthFleet'         # NO EXTERNAL
        - $ref: '#/components/parameters/pathStreamId'
        - $ref: '#/components/parameters/queryLastEventId'
      responses:
        '200':
          description: OK
          headers:
            retry-after:
              schema:
                type: integer
                format: int32
              description: >-
                Numero di millisecondi di attesa prima di effettuare una nuova lettura di eventi. <br/>
                Sarà valorizzato a zero se ci sono eventi in coda che non sono stati forniti per 
                raggiunta dimensione massima della risposta. <br/>
                Sarà maggiore di zero se gli eventi in coda sono stati tutti inviati.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProgressResponse"
        '419':
          description: Too Many Requests
          headers:
            retry-after:
              schema:
                type: integer
                format: int32
              description: >-
                Numero di millisecondi di attesa prima di effettuare una nuova lettura di eventi.
        '400':
          description: Invalid input
          content:
            application/problem+json:
              schema:
                $ref: 'remote-refs.yaml#/components/schemas/Problem'
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: 'remote-refs.yaml#/components/schemas/Problem'
    

    ############################################################################################
    ###                INVIO DI EVENTI DA PARTE DELLA PUBBLICA AMMNISTRAZIONE                ###
    ############################################################################################

  '/delivery-progresses/events':                                                              # NOT YET IMPLEMENTED
    post:                                                                                     # NOT YET IMPLEMENTED
      summary: Invio eventi da parte della PA                                                 # NOT YET IMPLEMENTED
      description: >-                                                                         # NOT YET IMPLEMENTED
        Questa API è a disposizione della Pubblica Amministrazione per inviare eventi, come   # NOT YET IMPLEMENTED
        quello di chiusura di una posizione debitoria con pagamento tramite F24, che possono  # NOT YET IMPLEMENTED
        avvenire fuori dal controllo di PagoPA. <br/>                                         # NOT YET IMPLEMENTED

        L'elaborazione può avvenire in maniera parziale, quindi ogni evento deve avere un     # NOT YET IMPLEMENTED
        identificativo univoco (generato dalla PA). In caso di fallimento vanno ritrasmessi   # NOT YET IMPLEMENTED
        gli eventi con lo stesso identificativo. Sarà Piattaforma Notifica ad identificare    # NOT YET IMPLEMENTED
        quelli già elaborati ed evitare duplicazioni. <br/>                                   # NOT YET IMPLEMENTED

        Allo stato attuale gli unici eventi sono quelli di pagamento                          # NOT YET IMPLEMENTED
      tags:                                                                                   # NOT YET IMPLEMENTED
        - Events                                                                              # NOT YET IMPLEMENTED
      operationId: informOnExternalEvent                                                      # NOT YET IMPLEMENTED
      parameters:                                                                             # NOT YET IMPLEMENTED
        - $ref: '#/components/parameters/uidAuthFleet'          # NO EXTERNAL                 # NOT YET IMPLEMENTED
        - $ref: '#/components/parameters/cxTypeAuthFleet'       # NO EXTERNAL                 # NOT YET IMPLEMENTED
        - $ref: '#/components/parameters/cxIdAuthFleet'         # NO EXTERNAL                 # NOT YET IMPLEMENTED
      requestBody:                                                                            # NOT YET IMPLEMENTED
        required: true                                                                        # NOT YET IMPLEMENTED
        content:                                                                              # NOT YET IMPLEMENTED
          application/json:                                                                   # NOT YET IMPLEMENTED
              schema:                                                                         # NOT YET IMPLEMENTED
                $ref: "#/components/schemas/ExternalEventsRequest"                            # NOT YET IMPLEMENTED
      responses:                                                                              # NOT YET IMPLEMENTED
        '204':                                                                                # NOT YET IMPLEMENTED
          description: OK                                                                     # NOT YET IMPLEMENTED
        '400':                                                                                # NOT YET IMPLEMENTED
          description: Invalid input                                                          # NOT YET IMPLEMENTED
          content:                                                                            # NOT YET IMPLEMENTED
            application/problem+json:                                                         # NOT YET IMPLEMENTED
              schema:                                                                         # NOT YET IMPLEMENTED
                $ref: 'remote-refs.yaml#/components/schemas/Problem'                 # NOT YET IMPLEMENTED
        '500':                                                                                # NOT YET IMPLEMENTED
          description: Internal Server Error                                                  # NOT YET IMPLEMENTED
          content:                                                                            # NOT YET IMPLEMENTED
            application/problem+json:                                                         # NOT YET IMPLEMENTED
              schema:                                                                         # NOT YET IMPLEMENTED
                $ref: 'remote-refs.yaml#/components/schemas/Problem'                 # NOT YET IMPLEMENTED
  
components:
  
  parameters:
    ############################################################################################
    ###                     PARAMETRI DI AUTENTICAZIONE E AUTORIZZAZIONE                     ###
    ############################################################################################
    cxTypeAuthFleet:                                                                                                                                            # NO EXTERNAL
      $ref: 'https://raw.githubusercontent.com/pagopa/pn-auth-fleet/main/docs/openapi/authenticationParameters-v1.yaml#/components/parameters/cxTypeAuthFleet'  # NO EXTERNAL
    cxIdAuthFleet:                                                                                                                                              # NO EXTERNAL
      $ref: 'https://raw.githubusercontent.com/pagopa/pn-auth-fleet/main/docs/openapi/authenticationParameters-v1.yaml#/components/parameters/cxIdAuthFleet'    # NO EXTERNAL
    uidAuthFleet:                                                                                                                                               # NO EXTERNAL
      $ref: 'https://raw.githubusercontent.com/pagopa/pn-auth-fleet/main/docs/openapi/authenticationParameters-v1.yaml#/components/parameters/uidAuthFleet'     # NO EXTERNAL


    ############################################################################################
    ###                                   PARAMETRI STREAMS                                  ###
    ############################################################################################
    queryLastEventId:
      description: >-
        Identificativo dell'ultimo evento memorizzato dal chiamante, se non passato si intende dal primo evento presente nello stream
      name: lastEventId
      in: query
      required: false
      schema:
        type: string
    pathStreamId:
      description: >-
        Identificativo dello stream di eventi
      name: streamId
      in: path
      required: true
      schema:
        type: string
        format: uuid

  schemas:
    
    ############################################################################################
    ###                          CREAZIONE E GESTIONE EVENT STREAM                           ###
    ############################################################################################
    StreamCreationRequest:
      description: Richiesta di creazione di uno stream di eventi di avanzamento delle notifiche.
      type: object
      required:
        - title
        - eventTYpe
      properties:
        title: 
          description: Nome sintetico dello stream
          type: string
        eventType:
          description: >-
            Tipo di eventi presenti nel flusso:
              - _STATUS_: cambiamenti di stato delle notifiche
              - _TIMELINE_: eventi a granularità fine
          type: string
          enum:
            - STATUS
            - TIMELINE
        filterValues:
          description: >-
            Se non _null_ indica l'elenco degli stati o elementi di timeline che 
            si vogliono ricevere.
          type: array
          items:
            type: string
    
    StreamMetadataResponse:
      description: Configurazioni di un flusso di eventi
      allOf:
        - $ref: '#/components/schemas/StreamCreationRequest'
        - type: object
          required:
            - streamId
            - activationDate
          properties:
            streamId:
              description: Identificativo del flusso di eventi
              type: string
              format: uuid
            activationDate:
              description: Timestamp in cui il flusso di eventi è stato attivato
              type: string
              format: date-time
    
    StreamListResponse:
      description: Elenco di flussi di eventi
      type: array
      items:
        $ref: '#/components/schemas/StreamListElement'

    StreamListElement:
      type: object
      required:
        - title
        - streamId
      properties:
        streamId:
          type: string
          format: uuid
        title: 
          type: string
        
    

    ############################################################################################
    ###                                  DEFINIZIONI EVENTI                                  ###
    ############################################################################################

    ###  - EVENTI GENERATI DA PN
    ###################################

    ProgressResponse:
      type: array
      items:
        $ref: '#/components/schemas/ProgressResponseElement'

    ProgressResponseElement:
      type: object
      required:
        - eventId
        - timestamp
      properties:
        eventId:
          description: >-
            Elemento che garantisce univocità e ordinamento temporale all'interno dello stream
          type: string
        timestamp:
          description: Istante a cui è avvenuto l'evento
          type: string
          format: date-time

        notificationRequestId:
          description: Identificativo della richiesta di notifica
          type: string
        iun:
          description: >-
            Identificativo della notifica, presente solo se la richiesta di notifica è 
            stata accettata.
          type: string

        newStatus:
          $ref: './schemas-pn-status-v1.yaml#/components/schemas/NotificationStatus'
        timelineEventCategory:
          $ref: './schemas-pn-timeline-v1.yaml#/components/schemas/TimelineElementCategory'
    
    ###  - EVENTI GENERATI DALLA P.A.
    ###################################
    ExternalEventsRequest:                                                              # NOT YET IMPLEMENTED
      title: Invio eventi da P.A. a P.N.                                                # NOT YET IMPLEMENTED
      description: >-                                                                   # NOT YET IMPLEMENTED
        Richiesta contenente un array di eventi di cui una Pubblica Amministrazione     # NOT YET IMPLEMENTED
        deve avvisare Piattaforma Notifiche.                                            # NOT YET IMPLEMENTED
      type: object                                                                      # NOT YET IMPLEMENTED
      required:                                                                         # NOT YET IMPLEMENTED
        - events                                                                        # NOT YET IMPLEMENTED
      properties:                                                                       # NOT YET IMPLEMENTED
        events:                                                                         # NOT YET IMPLEMENTED
          description: Elenco degli eventi                                              # NOT YET IMPLEMENTED
          type: array                                                                   # NOT YET IMPLEMENTED
          items:                                                                        # NOT YET IMPLEMENTED
            $ref: '#/components/schemas/ExternalEvent'                                  # NOT YET IMPLEMENTED

    ExternalEvent:                                                                      # NOT YET IMPLEMENTED
      title: Un evento generato all'esterno di PN.                                      # NOT YET IMPLEMENTED
      description: >-                                                                   # NOT YET IMPLEMENTED
        Un evento riguardante la notifica generato all'esterno di Piattaforma Notifiche come, # NOT YET IMPLEMENTED
        ad esempio, il pagamento che può avvenire anche tramite F24. <br/>                    # NOT YET IMPLEMENTED
                                                                                              # NOT YET IMPLEMENTED
        Deve essere valorizzata una solo campo, quello specifico del tipo di evento.          # NOT YET IMPLEMENTED
      type: object                                                                      # NOT YET IMPLEMENTED
      properties:                                                                       # NOT YET IMPLEMENTED
        payment:                                                                        # NOT YET IMPLEMENTED
          $ref: '#/components/schemas/PaymentEvent'                                     # NOT YET IMPLEMENTED
    
    PaymentEvent:                                                                       # NOT YET IMPLEMENTED
      title: Evento di pagamento                                                        # NOT YET IMPLEMENTED
      description: >-                                                                   # NOT YET IMPLEMENTED
        Comprende: <br/>                                                                # NOT YET IMPLEMENTED
          - data e ora del pagamento, <br/>                                             # NOT YET IMPLEMENTED
          - modalità di pagamento (PAGOPA / F24), <br/>                                 # NOT YET IMPLEMENTED
          - lo _IUN_ della notifica pagata, <br/>                                       # NOT YET IMPLEMENTED
          - il codice fiscale del destinatario pagatore, <br/>                          # NOT YET IMPLEMENTED
          - e la tipologia del destinatario pagatore (PF / PG). <br/>                   # NOT YET IMPLEMENTED
      type: object                                                                      # NOT YET IMPLEMENTED
      required:                                                                         # NOT YET IMPLEMENTED
        - iun                                                                           # NOT YET IMPLEMENTED
        - recipientTaxId                                                                # NOT YET IMPLEMENTED
        - recipientType                                                                 # NOT YET IMPLEMENTED
        - paymentType                                                                   # NOT YET IMPLEMENTED
        - timestamp                                                                     # NOT YET IMPLEMENTED
      properties:                                                                       # NOT YET IMPLEMENTED
        iun:                                                                            # NOT YET IMPLEMENTED
          type: string                                                                  # NOT YET IMPLEMENTED
        recipientTaxId:                                                                 # NOT YET IMPLEMENTED
          type: string                                                                  # NOT YET IMPLEMENTED
        recipientType:                                                                  # NOT YET IMPLEMENTED
          $ref: './schemas-pn-notification-v1.yaml#/components/schemas/RecipientType'   # NOT YET IMPLEMENTED
        paymentType:                                                                    # NOT YET IMPLEMENTED
          type: string                                                                  # NOT YET IMPLEMENTED
          enum:                                                                         # NOT YET IMPLEMENTED
            - F24                                                                       # NOT YET IMPLEMENTED
            - PAGOPA                                                                    # NOT YET IMPLEMENTED
        timestamp:                                                                      # NOT YET IMPLEMENTED
          type: string                                                                  # NOT YET IMPLEMENTED
          format: date-time                                                             # NOT YET IMPLEMENTED
        
  
#  securitySchemes:        # ONLY EXTERNAL
#    ApiKeyAuth:           # ONLY EXTERNAL
#      type: apiKey        # ONLY EXTERNAL
#      in: header          # ONLY EXTERNAL
#      name: x-api-key     # ONLY EXTERNAL

#security:                 # ONLY EXTERNAL
#  - ApiKeyAuth: [] # use the same name as under securitySchemes    # ONLY EXTERNAL
              
