AWSTemplateFormatVersion: 2010-09-09
Description: 'Example microservice deploy'
Transform:
  - UpdateDeploymentTransform

Parameters:
  ProjectName:
    Type: String
    Description: 'Usually pn can be pnXYZ where XYZ are the feature number, useful to create
      experimental environments without crash official development environment'

  PhysicalPersonPortalUrl:
    Type: String
    Description: 'Url del portale della Persona Fisica da inserire degli AAR'
    
  LegalPersonPortalUrl:
    Type: String
    Description: 'Url del portale della Persona Giuridica da inserire degli AAR'    

  AddressBookUrl:
    Type: String
    Description: 'The URL of address book mock service'

  WebhookScanInterval:
    Type: String
    Description: 'Time interval between two webhook-scans every scan send notifications
                  update to Public Administration'

  WebhookMaxLength:
    Type: String
    Description: 'Max elements quantity for each webhook call'

  WaitingForReadCourtesyMessage:
    Type: String
    Description: 'Time to wait before starting the analog workflow. See https://docs.spring.io/spring-boot/docs/2.1.12.RELEASE/reference/html/boot-features-external-config.html#boot-features-external-config-conversion-duration'

  SecondNotificationWorkflowWaitingTime:
    Type: String
    Description: 'Time to wait from first to second pec attempt. See https://docs.spring.io/spring-boot/docs/2.1.12.RELEASE/reference/html/boot-features-external-config.html#boot-features-external-config-conversion-duration'
  
  SchedulingDaysSuccessDigitalRefinement:
    Type: String
    Description: 'Refinement time for digital workflow success. See https://docs.spring.io/spring-boot/docs/2.1.12.RELEASE/reference/html/boot-features-external-config.html#boot-features-external-config-conversion-duration'

  SchedulingDaysFailureDigitalRefinement:
    Type: String
    Description: 'Refinement time for digital workflow failure. See https://docs.spring.io/spring-boot/docs/2.1.12.RELEASE/reference/html/boot-features-external-config.html#boot-features-external-config-conversion-duration'

  SchedulingDaysSuccessAnalogRefinement:
    Type: String
    Description: 'Refinement time for Analog workflow success. See https://docs.spring.io/spring-boot/docs/2.1.12.RELEASE/reference/html/boot-features-external-config.html#boot-features-external-config-conversion-duration'

  SchedulingDaysFailureAnalogRefinement:
    Type: String
    Description: 'Refinement time for Analog workflow failure. See https://docs.spring.io/spring-boot/docs/2.1.12.RELEASE/reference/html/boot-features-external-config.html#boot-features-external-config-conversion-duration'
  
  AttachmentRetentionTimeAfterValidation:
    Type: String
    Description: 'Attachment retention after validation. Note: This number is defined on safeStorage, so a change to these properties does not imply a change to effective file retention'
  
  CheckAttachmentTimeBeforeExpiration:
    Type: String
    Description: 'Defines how long before the attachment retention expires need to start "check attachment retention"'
  
  ActionQueueMap:
    Type: String
    Description: 'Define relation from actionType to sqs queue name'
  
  QueueUrlMap:
    Type: String
    Description: 'Define relation from queue name to sqs queue url'
    
  AttachmentTimeToAddAfterExpiration:
    Type: String
    Description: 'Time to add when attachment retention is expiring'

  ApiDnsName:
    Type: String
    Description: 'The DNS name used for B2B rest API.'

  WebApiDnsName:
    Type: String
    Description: 'The DNS name used for WEB rest API.'

  IoApiDnsName:
    Type: String
    Description: 'The DNS name used for IO rest API.'

  CorsAllowedDomains:
    Type: String
    Description: 'Comma separated list of domains allowed to make cross origin request'

  ContainerImageUri:
    Type: String
    Description: 'Exact container image URI with full repository and image digest'

  MicroserviceNumber:
    Type: Number
    Description: 'Disambiguation useful for load balancer rules'

  TemplateBucketBaseUrl:
    Type: String
    Description: 'The S3 bucket from which to fetch the templates used by this stack.'
  
  DeliveryPushInputsQueueName:
    Type: String
    Description: 'Queue to pull for inputs event'
    
  DeliveryPushInputsQueueARN:
    Type: String
    Description: 'Queue to pull for inputs event'

  DeliveryPushInputsQueueAlarmARN:
    Type: String
    Description: 'pn-delivery-push input queue alarm ARN'

  DeliveryPushInputsQueueAgeAlarmARN:
    Type: String
    Description: pn-delivery-push input queue age alarm ARN
    
  DeliveryPushValidationInputsQueueName:
    Type: String
    Description: DeliveryPushValidationInputsQueue queue name
    
  DeliveryPushValidationInputsQueueURL:
    Type: String
    Description: DeliveryPushValidationInputsQueue queue URL
    
  DeliveryPushValidationInputsQueueARN:
    Type: String
    Description: DeliveryPushValidationInputsQueue queue ARN
    
  DeliveryPushValidationInputsQueueAlarmARN:
    Type: String
    Description: DeliveryPushValidationInputsQueue alarm ARN
    
  DeliveryPushValidationInputsQueueAgeAlarmARN:
    Type: String
    Description: DeliveryPushValidationInputsQueue age alarm ARN

  ExternalChannelsOutputsQueueName:
    Type: String
    Description: 'Pull external-channel messages from this Queue'
    
  ExternalChannelsOutputsQueueARN:
    Type: String
    Description: 'Pull external-channel messages from this Queue'

  ScheduledActionsQueueName:
    Type: String
    Description: 'Send and pull ready-to-do actions th this queue'
    
  ScheduledActionsQueueARN:
    Type: String
    Description: 'Send and pull ready-to-do actions th this queue'

  ScheduledValidationActionsQueueName:
    Type: String
    Description: 'Send and pull ready-to-do actions th this queue'

  ScheduledValidationActionsQueueARN:
    Type: String
    Description: 'Send and pull ready-to-do actions th this queue'
    
  ActionRouterDLQName:
    Type: String
    Description: 'DLQ Name for ActionRouterLambda'

  ActionRouterDLQARN:
    Type: String
    Description: 'DLQ ARN for ActionRouter lambda'
  
  ActionRouterDLQAlarmARN:
    Type: String
    Description: 'DLQ ARN for ActionRouter lambda'

  ActionEnqueuerDLQARN:
    Type: String
    Description: 'DLQ ARN for ActionEnqueuer lambda'
    
  ActionEnqueuerDLQAlarmARN:
    Type: String
    Description: 'DLQ ARN for ActionEnqueuer lambda'
      
  DoneActionsQueueName:
    Type: String
    Description: 'Send done actions to this queue read by webhook'

  DoneActionsQueueURL:
    Type: String
    Description: 'Send done actions to this queue read by webhook'

  DoneActionsQueueARN:
    Type: String
    Description: 'Send done actions to this queue read by webhook'

  ECSClusterName:
    Type: String
    Description: 'The name of the ECS cluster where the microservice is going to be deployed'

  SubnetsIds:
    Type: CommaDelimitedList
    Description: 'subnets ids comma separated list. Where to deploy the microservice'

  VpcId:
    Type: String
    Description: 'VpcId where the microservice is going to be deployed'
  
  EcsDefaultSecurityGroup:
    Type: String
    Description: 'Default security group required by infrastructure'

  ApplicationLoadBalancerListenerArn:
    Type: String
    Description: 'Load balancer listener where HTTP endpoints is going to be registered'

  ApplicationLoadBalancerDomain:
    Type: String
    Description: 'Base URL of the load balancer where the service is going to be reachable'

  NetworkLoadBalancerLink:
    Type: String
    Description: 'Network load balancer link for API-GW'

  TimelinesDynamoTableName:
    Type: String
    Description: 'Name of dynamodb table containing timelines'

  TimelinesDynamoTableArn:
    Type: String
    Description: 'ARN of dynamodb table containing timelines'

  TimelinesCounterTableName:
    Type: String
    Description: Name of dynamodb used by application to access the key-value store of CounterTable

  TimelinesCounterTableArn:
    Type: String
    Description: ARN Dynamo Name used by application to access the key-value store of CounterTable

  PaperNotificationFailedDynamoTableName:
    Type: String
    Description: 'Name of dynamodb table containing unreacheble notifications recipients'

  PaperNotificationFailedDynamoTableArn:
    Type: String
    Description: 'ARN of dynamodb table containing unreacheble notifications recipients'

  ActionDynamoTableName:
    Type: String
    Description: 'Name of dynamodb table containing'

  ActionDynamoTableArn:
    Type: String
    Description: 'ARN of dynamodb table containing'

  FutureActionDynamoTableName:
    Type: String
    Description: 'Name of dynamodb table containing'

  FutureActionDynamoTableArn:
    Type: String
    Description: 'ARN of dynamodb table containing'

  LastPollForFutureActionDynamoTableName:
    Type: String
    Description: 'Name of dynamodb table containing'

  LastPollForFutureActionDynamoTableArn:
    Type: String
    Description: 'ARN of dynamodb table containing'

  PnDeliveryPushShedLockDynamoTableName:
    Type: String
    Description: 'Name of dynamodb table containing'

  PnDeliveryPushShedLockDynamoTableArn:
    Type: String
    Description: 'ARN of dynamodb table containing'

  PnDeliveryPushWebhookStreamsTableName:
    Type: String
    Description: 'Name of dynamodb table containing'

  PnDeliveryPushWebhookStreamsTableArn:
    Type: String
    Description: 'ARN of dynamodb table containing'

  PnDeliveryPushWebhookEventsTableName:
    Type: String
    Description: 'Name of dynamodb table containing'

  PnDeliveryPushWebhookEventsTableArn:
    Type: String
    Description: 'ARN of dynamodb table containing'

  DocumentCreationRequestTableName:
    Type: String
    Description: 'Name of dynamodb table containing unreacheble notifications recipients'

  DocumentCreationRequestTableArn:
    Type: String
    Description: 'ARN of dynamodb table containing unreacheble notifications recipients'
      
  AlarmSNSTopicArn:
    Type: String
    Description: 'ARN of alarm topic'

  AddressManagerBaseUrl:
    Type: String
    Description: 'Address manager base url'

  ExternalChannelBaseUrl:
    Type: String
    Description: 'External channel base url'
    
  SandboxSafeStorageBaseUrl:
    Type: String
    Description: 'Safe storage base url'

  MaxPdfAllowedSize:
    Type: String
    Description: 'Max pdf allowed size, -1 for disable check'

  EnableCheckPdfContent:
    Type: String
    Description: 'Enable pdf content check'
  
  CheckCfEnabled:
    Type: String
    Description: 'Enable check cf'
    
  Version:
    Type: String
    Description: 'Keep track of used projects commitIds'

  NotificationNonVisibilityTime:
    Type: String
    Description: 'After this time the notification may not have been read by recipient in that day. Format hh:mm example 21:00. 
    Link Documentation https://pagopa.atlassian.net/wiki/spaces/PN/pages/523304961/Piattaforma+Notifiche+-+Manuale+Operativo#:~:text=La%20notifica%20si,L.%2076/2020).'

  TimeToAddInNonVisibilityTimeCase:
    Type: String
    Description: 'Time to add to scheduling in case the notification arrived after the time defined in notificationNonVisibilityTime
    Link Documentation https://pagopa.atlassian.net/wiki/spaces/PN/pages/523304961/Piattaforma+Notifiche+-+Manuale+Operativo#:~:text=La%20notifica%20si,L.%2076/2020).'

  ExternalChannelDigitalRetryCount:
    Type: String
    Description: 'Numero ritentativi nel caso di esiti con retry ricevuti da ext-channel'

  ExternalChannelDigitalRetryDelay:
    Type: String
    Description: 'Delay fra ritentativi nel caso di esiti con retry ricevuti da ext-channel'

  ExternalChannelDigitalSendNoResponseTimeout:
    Type: String
    Description: 'Massima durata di attesa di risposta da parte di ext-channel'
  
  LogsKinesisSourceStreamArn:
    Type: String
    Description: 'Kinesis stream that receive logs'
  
  CdcPnActionArn:
    Type: String
    Description: 'Kinesis stream for pn-action'
    
  IsMvpDefaultValue:
    Type: String
    Description: 'default value to return if paTaxId not present in parameter store'
    AllowedValues: [ true, false ]

  IsLollipopActive:
    Type: String
    Description: 'lollipop authorization activation flag'
    AllowedValues: [ true, false ]
    Default: false

  #quickWorkAroundForPN-9116
  SendMoreThan20GramsDefaultValue:
    Type: String
    Description: |
      Valore di default dell'abilitazione ad inviare notifche con piú di 2 fogli oltre l'AAR (20 grammi).
      Il valore di abilitazione puó essere sovrascritto dal Parameter Store MapPaSendMoreThan20Grams nel parametro canSendMoreThan20Grams.
    AllowedValues: [ true, false ]
    Default: false

  RetentionAttachmentDaysAfterRefinement:
    Type: String
    Description: 'Number of days after which an attachment can be deleted from the effective date (viewing or expiration of time)'
  
  PagoPaNotificationBaseCost:
    Type: String
    Description: 'PagoPa notification base cost'
    Default: '100'

  SafeStorageToDeliveryPushQueueName:
    Type: String
    Description: 'SafeStorage-to-delivery-push queue Name'
    
  SafeStorageToDeliveryPushQueueARN:
    Type: String
    Description: 'SafeStorage-to-delivery-push queue ARN'

  SafeStorageToDeliveryPushQueueAlarmARN:
    Type: String
    Description: SafeStorage-to-delivery-push queue alarm ARN

  SafeStorageToDeliveryPushQueueAgeAlarmARN:
    Type: String
    Description: SafeStorage-to-delivery-push queue age alarm ARN
  
  AddressManagerToDeliveryPushQueueName:
    Type: String
    Description: 'AddressManager-to-delivery-push queue Name'

  F24ToDeliveryPushQueueName:
    Type: String
    Description: F24-to-delivery-push Queue Name

  F24ToDeliveryPushQueueARN:
    Type: String
    Description: F24-to-delivery-push queue ARN

  F24ToDeliveryPushQueueAlarmARN:
    Type: String
    Description: F24-to-delivery-push queue alarm ARN

  F24ToDeliveryPushQueueAgeAlarmARN:
    Type: String
    Description: F24-to-delivery-push queue age alarm ARN

  AddressManagerToDeliveryPushQueueARN:
    Type: String
    Description: AddressManager-to-delivery-push queue ARN

  AddressManagerToDeliveryPushQueueAlarmARN:
    Type: String
    Description: AddressManager-to-delivery-push queue alarm ARN

  AddressManagerToDeliveryPushQueueAgeAlarmARN:
    Type: String
    Description: AddressManager-to-delivery-push queue age alarm ARN
  
  DoneActionsQueueAlarmARN:
    Type: String
    Description: delivery push actions queue dlq alarm ARN

  DoneActionsQueueAgeAlarmARN:
    Type: String
    Description: delivery push actions queue age alarm ARN

  ScheduledActionsQueueAlarmARN:
    Type: String
    Description: delivery push actions done queue dlq alarm ARN

  ScheduledActionsQueueAgeAlarmARN:
    Type: String
    Description: delivery push actions done queue age alarm ARN
  
  ScheduledValidationActionsQueueAlarmARN:
    Type: String
    Description: delivery push validation actions queue dlq alarm ARN
    
  ScheduledValidationActionsQueueAgeAlarmARN:
    Type: String
    Description: delivery push validation actions queue age alarm ARN

  AlbSecurityGroup:
    Type: String
    Description: 'Application load balancer security group'

  # OpenApi Bucket params
  MicroserviceBucketName:
    Type: String
    Default: ''
    Description: 'Name of the bucket where the microservice files are copied during deploy'

  MicroserviceBucketBaseKey:
    Type: String
    Default: ''
    Description: 'Base key of the microservice in the s3 bucket'

  NationalRegistries2DeliveryPushQueueName:
    Type: String
    Description: 'National Registries to delivery-push queue name'

  NationalRegistries2DeliveryPushQueueARN:
    Type: String
    Description: 'National Registries to delivery-push queue ARN'

  NationalRegistries2DeliveryPushQueueAlarmARN:
    Type: String
    Description: 'National Registries to delivery-push queue dlq alarm'

  NationalRegistries2DeliveryPushQueueAgeAlarmARN:
    Type: String
    Description: 'National Registries to delivery-push queue age alarm'

  DeliveryPushToExternalRegistriesQueueURL: # defined in pn-infra
    Type: String
    Description: 'delivery-push to external-registries queue URL'

  DeliveryPushToExternalRegistriesQueueARN: # defined in pn-infra
    Type: String
    Description: 'delivery-push to external-registries queue ARN'

  ValidationRetryIntervals:
    Type: String
    Description: 'Time interval between validations retry'
    
  # Log group parameters
  EcsLogGroup:
    Type: String
    Description: 'Ecs log group name'

  # Heath Check parameters
  HealthCheckInterval:
    Description: Seconds between two health check
    Type: Number
    Default: 60

  HealthCheckTimeout:
    Description: health check timeout seconds
    Type: Number
    Default: 5
  
  HealthyThresholdCount:
    Description: |
      The number of consecutive health checks successes required before considering 
      an unhealthy target healthy. 
    Type: Number
    Default: 5
  
  UnhealthyThresholdCount:
    Description: |
      The number of consecutive health check failures required before considering a target unhealthy. 
    Type: Number
    Default: 2

  # Instance parameters
  # 256 (.25 vCPU) - Available memory values: 0.5GB, 1GB, 2GB
  # 512 (.5 vCPU) - Available memory values: 1GB, 2GB, 3GB, 4GB
  # 1024 (1 vCPU) - Available memory values: 2GB, 3GB, 4GB, 5GB, 6GB, 7GB, 8GB
  # 2048 (2 vCPU) - Available memory values: Between 4GB and 16GB in 1GB increments
  # 4096 (4 vCPU) - Available memory values: Between 8GB and 30GB in 1GB increments
  CpuValue:
    Type: Number
    Default: 1024
    Description: Fargate virtual CPU quantity 1024 equals one vCPU

  # 0.5GB, 1GB, 2GB - Available cpu values: 256 (.25 vCPU)
  # 1GB, 2GB, 3GB, 4GB - Available cpu values: 512 (.5 vCPU)
  # 2GB, 3GB, 4GB, 5GB, 6GB, 7GB, 8GB - Available cpu values: 1024 (1 vCPU)
  # Between 4GB and 16GB in 1GB increments - Available cpu values: 2048 (2 vCPU)
  # Between 8GB and 30GB in 1GB increments - Available cpu values: 4096 (4 vCPU)
  MemoryAmount:
    Type: String
    Default: 2GB
    Description: memory amount reserved to the task pod.
    AllowedValues: [ 2GB, 4GB, 6GB, 8GB ]

  # Autoscaling parameters
  AutoscalingCheckPeriod:
    Default: 60
    Type: Number
    Description: minimum autoscaling number of tasks\

  AutoscalingDataPointN:
    Default: 1
    Type: Number
    Description: activate when N datapoint on M

  AutoscalingDataPointM:
    Default: 1
    Type: Number
    Description: activate when N datapoint on M

  AutoscalingThreshold:
    Default: 70
    Type: String
  
  MinTasksNumber:
    Default: 1
    Type: Number
    Description: minimum autoscaling number of tasks

  MaxTasksNumber:
    Default: 6
    Type: Number
    Description: maximum autoscaling number of tasks

  PnSendMode:
    Default: '1970-01-01T00:00:00Z;AAR-DOCUMENTS-PAYMENTS;AAR;AAR;AAR_NOTIFICATION,2024-02-13T23:00:00Z;AAR-DOCUMENTS-PAYMENTS;AAR;AAR-DOCUMENTS-PAYMENTS;AAR_NOTIFICATION,2024-03-31T23:00:00Z;AAR;AAR;AAR-DOCUMENTS-PAYMENTS;AAR_NOTIFICATION_RADD'
    Type: String
    Description: 'Configuration for send notification attachment, AAR, and AAR type. Comma separated list made up by: "Configuration start time" (UTC);"Send attachment mode for analog";"Send attachment mode for simple registered letter";"Send attachment mode for legal mail";"AAR template type"'

  SafeStorageFileNotFoundRetry:
    Default: false
    Type: String
    AllowedValues:
      - true
      - false
    Description: 'Enables retry of the notification validation in case of SafeStorage 404 error'

  LandingUrl:
    Type: String
    Description: 'SEND landing URL'

  LogAlarmStrategy:
    Type: String
    Default: 'FATAL'
    
  ConsumedQueueMessagePerMinute:
    Type: Number
    Default: 0
    Description: Weight to assign to queue number of visible messages metric

  ApplicationLoadBalancerMetricsDimensionName:
    Type: String
    Default: ''
    Description: Application load balancer dimension name
    
  IOBackendCidrs:
    Type: String
    Default: ''

  VersioningV1V2WebhookLambdaName:
    Type: String
    Description: 'VersioningV1V2WebhookLambdaName'

  VersioningV1V2WebhookLambdaProvisionedConcurrency:
    Type: Number
    Description: 'VersioningV1V2WebhookLambdaProvisionedConcurrency'
    Default: 1
      
  ActionRouterKinesisBatchSize:
    Type: Number
    Description: "Batch size for kinesis to lambda action router"
  
  ActionCdcKinesisStreamShardCount:
    Type: Number
    Description: "Shard count for action cdc stream kinesis"
  
  ActionCdcKinesisStreamRetention:
    Type: Number
    Description: "Retention for action cdc stream kinesis"
  
  ActionCdcKinesisStandardAlarmThresholdsMs:
    Type: Number
    Description: "Standard alarm threshold for action cdc kinesis"
  
  ActionCdcKinesisOnCallAlarmThresholdsMs:
    Type: Number
    Description: "OnCall alarm threshold for action cdc kinesis"
    
  ActionRouterLambdaName:
    Type: String
    
  ValidationMessageEventBridgeToQueueLambdaName:
    Type: String
    
  WebhookEventManagerLambdaName:
    Type: String
  
  WebhookEventManagerDLQARN:
    Type: String
    Description: 'DLQ ARN for WebhookEventManagerLambda'

  WebhookEventManagerDLQAlarmARN:
    Type: String
    Description: 'DLQ Alarm ARN for WebhookEventManagerLambda'

  PaperEventsCostUpdateLambdaName:
    Type: String

  PaperEventsCostUpdateDLQARN:
    Type: String
    Description: 'DLQ ARN for PaperEventsCostUpdateLambda'

  PaperEventsCostUpdateDLQAlarmARN:
    Type: String
    Description: 'DLQ Alarm ARN for PaperEventsCostUpdateLambda'
  
  # Lambda parameters

  NotificationCancellationActionInsertLambdaName:
    Type: String

  NotificationCancellationActionInsertDLQARN:
    Type: String
    Description: 'DLQ ARN for NotificationCancellationActionInsertLambda'

  NotificationCancellationActionInsertDLQAlarmARN:
    Type: String
    Description: 'DLQ Alarm ARN for NotificationCancellationActionInsertLambda'

  ActionTtlDays:
    Default: 365
    Type: Number
    Description: TTL in days for pn-Action table rows

  # CDC

  CdcKinesisSourceStreamArn:
    Type: String
    Description: 'Where to send CDC'

  CdcKinesisSourceStreamKeyArn:
    Description: "Kinesis source CDC stream crypto key ARN"
    Type: String

  CdCPnActionArn:
    Type: String
    Description: 'Where to send action CDC'
    
  #Webhook event manager lambda parameters
  WebhookEventManagerLambdaMaximumBatchingWindowInSeconds:
    Type: String
    Default: "20"
    Description: 'MaximumBatchingWindow asseveration event source mapping'

  WebhookEventManagerLambdaBatchSize:
    Type: String
    Default: "60"
    Description: 'BatchSize asseveration event source mapping'


  #Webhook event manager lambda parameters
  NotificationCancellationActionInsertLambdaMaximumBatchingWindowInSeconds:
    Type: String
    Default: "60"
    Description: 'MaximumBatchingWindow asseveration event source mapping'

  NotificationCancellationActionInsertLambdaBatchSize:
    Type: String
    Default: "20"
    Description: 'BatchSize asseveration event source mapping'

  # Paper Cost Notification lambda parameters
  PaperEventsCostUpdateLambdaMaximumBatchingWindowInSeconds:
    Type: String
    Default: "20"
    Description: 'MaximumBatchingWindow asseveration event source mapping'

  PaperEventsCostUpdateLambdaBatchSize:
    Type: String
    Default: "60"
    Description: 'BatchSize asseveration event source mapping'

  EnhancedWebSecurityEnabled:
    Type: String
    Default: false
    Description: Enable additional WAF Web rules
    AllowedValues:
      - true
      - false

  F24DeliveryPushUser:
    Type: String
    Description: 'pn-delivery-push clientId for communication with pn-f24'

  B2bWafLimit:
    Default: 600000
    Type: Number
    Description: b2b waf limit

  WebWafLimit:
    Default: 600000
    Type: Number
    Description: web waf limit

  # Logging parameters
  WireTapLogActivation:
    Type: String
    Default: false
    Description: Activation of wire logs
    AllowedValues:
      - true
      - false

  PnCronAnalyzer:
    Type: String
    Default: '-'
    Description: Cron for which you send the metric to CloudWatch

  # EFS parameters
  FargateEFSFileSystemID:
    Type: String
    Description: "EFS Filesystem"

  MountEfs:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"

  RaddOperatorCaf:
    Type: String
    Description: 'Radd Operator Caf'

  RaddOperatorMooney:
    Type: String
    Description: 'Radd Operator Mooney'

  RaddOperatorSailpost:
    Type: String
    Description: 'Radd Operator Sail'

  ErrorCorrectionLevelQrCode:
    Type: String
    Description: 'Error correction level in ZXing library used to generate qrCode'
    Default: 'h'
    AllowedValues:
      - "l"
      - "m"
      - "q"
      - "h"

  PerformanceImprovementStartDate:
    Type: String
    Description: 'Start Date enable feature flag performance improvement'

  PerformanceImprovementEndDate:
    Type: String
    Description: 'End date enable feature flag performance improvement'
  
  EnvironmentType:
    Type: String
    Description: Environment type
    
Conditions:
  UseExternalChannelMock: !Equals [ !Ref ExternalChannelBaseUrl, "Mock" ]
  IsEnvironmentDev: !Equals [ !Ref EnvironmentType, "dev" ]

Resources:

  # PN-Delivery-push microservice
  DeliveryPushMicroservice:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/ecs-service.yaml"
      Parameters:
        MicroServiceUniqueName: !Sub '${ProjectName}-delivery-push'
        CpuValue: !Ref CpuValue
        MemoryAmount: !Ref MemoryAmount
        HealthCheckTimeout: !Ref HealthCheckTimeout
        HealthCheckInterval: !Ref HealthCheckInterval
        HealthyThresholdCount: !Ref HealthyThresholdCount
        UnhealthyThresholdCount: !Ref UnhealthyThresholdCount
        AutoscalingStrategy: CUSTOM
        AutoscalingThreshold: !Ref AutoscalingThreshold
        AutoscalingCheckPeriod: !Ref AutoscalingCheckPeriod
        MinTasksNumber: !Ref MinTasksNumber
        MaxTasksNumber: !Ref MaxTasksNumber
        AutoscalingDataPointN: !Ref AutoscalingDataPointN
        AutoscalingDataPointM: !Ref AutoscalingDataPointM
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        EfsFilesystem: !Ref FargateEFSFileSystemID
        MountEfs: !Ref MountEfs
        WireTapLogActivation: !Ref WireTapLogActivation
        ContainerImageURI: !Sub '${ContainerImageUri}'
        ContainerEnvEntry1: !Sub 'AWS_REGIONCODE=${AWS::Region}'
        ContainerEnvEntry2: !Sub 'PN_DELIVERYPUSH_TOPICS_NEWNOTIFICATIONS=${DeliveryPushInputsQueueName}'
        ContainerEnvEntry3: !Sub 'PN_DELIVERYPUSH_WEBAPP_DIRECTACCESSURLTEMPLATEPHYSICAL=${PhysicalPersonPortalUrl}'
        ContainerEnvEntry4: !Sub 'PN_DELIVERYPUSH_WEBAPP_DIRECTACCESSURLTEMPLATELEGAL=${LegalPersonPortalUrl}'
        ContainerEnvEntry5: !Sub 'PN_DELIVERYPUSH_PAPERCHANNELBASEURL=http://${ApplicationLoadBalancerDomain}:8080'
        ContainerEnvEntry6: !Sub 'PN_DELIVERYPUSH_TOPICS_FROMEXTERNALCHANNEL=${ExternalChannelsOutputsQueueName}'
        ContainerEnvEntry7: !Sub 'PN_DELIVERYPUSH_TOPICS_SCHEDULEDACTIONS=${ScheduledActionsQueueName}'
        ContainerEnvEntry8: !Sub 'PN_DELIVERYPUSH_TOPICS_EXECUTEDACTIONS=${DoneActionsQueueName}'
        ContainerEnvEntry9: !Sub 'PN_DELIVERYPUSH_WEBHOOK_SCHEDULEINTERVAL=${WebhookScanInterval}'
        ContainerEnvEntry10: !Sub 'PN_DELIVERYPUSH_WEBHOOK_MAXLENGTH=${WebhookMaxLength}'
        ContainerEnvEntry11: 'PN_DELIVERYPUSH_WEBAPP_QUICKACCESSURLAARDETAILSUFFIX=?aar'
        ContainerEnvEntry12: !Sub 'PN_DELIVERYPUSH_WEBHOOKDAO_EVENTSTABLENAME=${PnDeliveryPushWebhookEventsTableName}'
        ContainerEnvEntry13: !Sub 'PN_DELIVERYPUSH_WEBHOOKDAO_STREAMSTABLENAME=${PnDeliveryPushWebhookStreamsTableName}'
        ContainerEnvEntry14: !Sub 'PN_DELIVERYPUSH_TIMEPARAMS_WAITINGFORREADCOURTESYMESSAGE=${WaitingForReadCourtesyMessage}'
        ContainerEnvEntry15: !Sub 'PN_DELIVERYPUSH_TIMEPARAMS_SECONDNOTIFICATIONWORKFLOWWAITINGTIME=${SecondNotificationWorkflowWaitingTime}'
        ContainerEnvEntry16: !Sub 'PN_DELIVERYPUSH_TIMEPARAMS_SCHEDULINGDAYSSUCCESSDIGITALREFINEMENT=${SchedulingDaysSuccessDigitalRefinement}'
        ContainerEnvEntry17: !Sub 'PN_DELIVERYPUSH_TIMEPARAMS_SCHEDULINGDAYSFAILUREDIGITALREFINEMENT=${SchedulingDaysFailureDigitalRefinement}'
        ContainerEnvEntry18: !Sub 'PN_DELIVERYPUSH_TIMEPARAMS_SCHEDULINGDAYSSUCCESSANALOGREFINEMENT=${SchedulingDaysSuccessAnalogRefinement}'
        ContainerEnvEntry19: !Sub 'PN_DELIVERYPUSH_TIMEPARAMS_SCHEDULINGDAYSFAILUREANALOGREFINEMENT=${SchedulingDaysFailureAnalogRefinement}'
        ContainerEnvEntry20:
          Fn::If:
            - UseExternalChannelMock
            - !Sub 'PN_DELIVERYPUSH_EXTERNALCHANNELBASEURL=http://${ApplicationLoadBalancerDomain}:8080'
            - !Sub 'PN_DELIVERYPUSH_EXTERNALCHANNELBASEURL=${ExternalChannelBaseUrl}'
        ContainerEnvEntry21: !Sub 'PN_DELIVERYPUSH_EXTERNALCHANNEL_DIGITALRETRYCOUNT=${ExternalChannelDigitalRetryCount}'
        ContainerEnvEntry22: !Sub 'PN_DELIVERYPUSH_EXTERNALCHANNEL_DIGITALRETRYDELAY=${ExternalChannelDigitalRetryDelay}'
        ContainerEnvEntry23: !Sub 'PN_DELIVERYPUSH_EXTERNALCHANNEL_DIGITALSENDNORESPONSETIMEOUT=${ExternalChannelDigitalSendNoResponseTimeout}'
        ContainerEnvEntry24: !Sub 'PN_DELIVERYPUSH_USERATTRIBUTESBASEURL=http://${ApplicationLoadBalancerDomain}:8080'
        ContainerEnvEntry25: !Sub 'PN_DELIVERYPUSH_SAFESTORAGEBASEURL=${SandboxSafeStorageBaseUrl}'
        ContainerEnvEntry26: !Sub 'PN_DELIVERYPUSH_DELIVERYBASEURL=http://${ApplicationLoadBalancerDomain}:8080'
        ContainerEnvEntry27: !Sub 'PN_DELIVERYPUSH_MANDATEBASEURL=http://${ApplicationLoadBalancerDomain}:8080'
        ContainerEnvEntry28: !Sub 'PN_DELIVERYPUSH_EXTERNALREGISTRYBASEURL=http://${ApplicationLoadBalancerDomain}:8080'
        ContainerEnvEntry29: !Sub
          - 'SPRING_CLOUD_FUNCTIONROUTER_QUEUES_LIST= ${ DeliveryPushValidationInputsQueueName}, ${ScheduledValidationActionsQueueName}, ${DeliveryPushInputsQueueName},${ExternalChannelsOutputsQueueName},${ScheduledActionsQueueName},${SafeStorageToDeliveryPushQueueName},${NationalRegistries2DeliveryPushQueueName},${AddressManagerToDeliveryPushQueueName},${F24ToDeliveryPushQueueName},${DoneActionsQueueName}'
        ContainerEnvEntry30: !Sub 'CORS_ALLOWED_DOMAINS=${CorsAllowedDomains}'
        ContainerEnvEntry31: !Sub 'PN_DELIVERYPUSH_TIMELINEDAO_TABLENAME=${TimelinesDynamoTableName}'
        ContainerEnvEntry32: !Sub 'PN_DELIVERYPUSH_FAILEDNOTIFICATIONDAO_TABLENAME=${PaperNotificationFailedDynamoTableName}'
        ContainerEnvEntry33: !Sub 'PN_DELIVERYPUSH_ACTIONDAO_TABLENAME=${ActionDynamoTableName}'
        ContainerEnvEntry34: !Sub 'PN_DELIVERYPUSH_FUTUREACTIONDAO_TABLENAME=${FutureActionDynamoTableName}'
        ContainerEnvEntry35: !Sub 'PN_DELIVERYPUSH_LASTPOLLFORFUTUREACTIONDAO_TABLENAME=${LastPollForFutureActionDynamoTableName}'
        ContainerEnvEntry36: !Sub 'PN_DELIVERYPUSH_LASTPOLLFORFUTUREACTIONDAO_LOCKTABLENAME=${PnDeliveryPushShedLockDynamoTableName}'
        ContainerEnvEntry37: !Sub 'PN_COMMONS_FEATURES_ISMVPDEFAULTVALUE=${IsMvpDefaultValue}'
        ContainerEnvEntry38: 'PN_DELIVERYPUSH_WEBAPP_FAQURLTEMPLATESUFFIX=faq'
        ContainerEnvEntry39: !Sub 'PN_DELIVERYPUSH_TIMEPARAMS_NOTIFICATIONNONVISIBILITYTIME=${NotificationNonVisibilityTime}'
        ContainerEnvEntry40: !Sub 'PN_DELIVERYPUSH_TIMEPARAMS_TIMETOADDINNONVISIBILITYTIMECASE=${TimeToAddInNonVisibilityTimeCase}'
        ContainerEnvEntry41: !Sub 'PN_DELIVERYPUSH_RETENTION_ATTACHMENT_DAYS_AFTER_REFINEMENT=${RetentionAttachmentDaysAfterRefinement}'
        ContainerEnvEntry42: !Sub 'PN_DELIVERYPUSH_TOPICS_SAFESTORAGEEVENTS=${SafeStorageToDeliveryPushQueueName}'
        ContainerEnvEntry43: !Sub 'PN_DELIVERYPUSH_NATIONALREGISTRIESBASEURL=http://${ApplicationLoadBalancerDomain}:8080'
        ContainerEnvEntry44: !Sub 'PN_DELIVERYPUSH_DOCUMENTCREATIONREQUESTDAO_TABLENAME=${DocumentCreationRequestTableName}'
        ContainerEnvEntry45: !Sub 'PN_DELIVERYPUSH_VALIDATIONRETRYINTERVALS=${ValidationRetryIntervals}'
        ContainerEnvEntry46: !Sub 'PN_DELIVERYPUSH_TOPICS_NATIONALREGISTRIESEVENTS=${NationalRegistries2DeliveryPushQueueName}'
        ContainerEnvEntry47: !Sub 'PN_DELIVERYPUSH_PNSENDMODE=${PnSendMode}'
        ContainerEnvEntry49: !Sub 'PN_DELIVERYPUSH_SAFESTORAGEFILENOTFOUNDRETRY=${SafeStorageFileNotFoundRetry}'
        ContainerEnvEntry50: !Sub 'PN_DELIVERYPUSH_WEBAPP_LANDINGURL=${LandingUrl}'
        ContainerEnvEntry51: 'PN_DELIVERYPUSH_WEBAPP_FAQSENDHASH=send-cosa-e'
        ContainerEnvEntry52: 'PN_DELIVERYPUSH_WEBAPP_FAQCOMPLETIONMOMENTHASH=perfezionamento-quando'
        ContainerEnvEntry53: !Sub 'PN_DELIVERYPUSH_ADDRESSMANAGERBASEURL=${AddressManagerBaseUrl}'
        ContainerEnvEntry54: !Sub 'PN_DELIVERYPUSH_TOPICS_ADDRESSMANAGEREVENTS=${AddressManagerToDeliveryPushQueueName}'
        ContainerEnvEntry55: !Sub 'PN_DELIVERYPUSH_CHECKPDFVALIDENABLED=${EnableCheckPdfContent}'
        ContainerEnvEntry56: !Sub 'PN_DELIVERYPUSH_CHECKPDFSIZE=${MaxPdfAllowedSize}'
        ContainerEnvEntry57: !Sub 'LOLLIPOP_ACTIVE=${IsLollipopActive}'
        ContainerEnvEntry58: !Sub 'PN_DELIVERYPUSH_TIMELINECOUNTERDAO_TABLENAME=${TimelinesCounterTableName}'
        ContainerEnvEntry59: !Sub 'PN_DELIVERYPUSH_CHECKCFENABLED=${CheckCfEnabled}'
        ContainerEnvEntry60: !Sub 'PN_DELIVERYPUSH_TOPICS_F24EVENTS=${F24ToDeliveryPushQueueName}'
        ContainerEnvEntry61: !Sub 'PN_DELIVERYPUSH_F24BASEURL=http://${ApplicationLoadBalancerDomain}:8080'
        ContainerEnvEntry62: !Sub 'PN_DELIVERYPUSH_F24CXID=${F24DeliveryPushUser}'
        ContainerEnvEntry63: !Sub 'PN_DELIVERYPUSH_PAGOPANOTIFICATIONBASECOST=${PagoPaNotificationBaseCost}'
        ContainerEnvEntry64: !Sub 'PN_DELIVERYPUSH_TIMEPARAMS_ATTACHMENTRETENTIONTIMEAFTERVALIDATION=${AttachmentRetentionTimeAfterValidation}'
        ContainerEnvEntry65: !Sub 'PN_DELIVERYPUSH_TIMEPARAMS_CHECKATTACHMENTTIMEBEFOREEXPIRATION=${CheckAttachmentTimeBeforeExpiration}'
        ContainerEnvEntry66: !Sub 'PN_DELIVERYPUSH_TIMEPARAMS_ATTACHMENTTIMETOADDAFTEREXPIRATION=${AttachmentTimeToAddAfterExpiration}'
        #quickWorkAroundForPN-9116
        ContainerEnvEntry67: !Sub 'PN_DELIVERYPUSH_SENDMORETHAN20GRAMSDEFAULTVALUE=${SendMoreThan20GramsDefaultValue}'
        ContainerEnvEntry68: !Sub 'PN_CRON_ANALYZER=${PnCronAnalyzer}'
        ContainerEnvEntry69: !Sub 'WIRE_TAP_LOG=${WireTapLogActivation}'
        ContainerEnvEntry70: !Sub 'PN_DELIVERYPUSH_WEBAPP_ADDITIONAL_RADDOPERATORCAF=${RaddOperatorCaf}'
        ContainerEnvEntry71: !Sub 'PN_DELIVERYPUSH_WEBAPP_ADDITIONAL_RADDOPERATORMOONEY=${RaddOperatorMooney}'
        ContainerEnvEntry72: !Sub 'PN_DELIVERYPUSH_WEBAPP_ADDITIONAL_RADDOPERATORSAILPOST=${RaddOperatorSailpost}'
        ContainerEnvEntry73: !Sub 'PN_DELIVERYPUSH_ERRORCORRECTIONLEVELQRCODE=${ErrorCorrectionLevelQrCode}'
        ContainerEnvEntry74: !Sub 'PN_DELIVERYPUSH_PERFORMANCEIMPROVEMENTSTARTDATE=${PerformanceImprovementStartDate}'
        ContainerEnvEntry75: !Sub 'PN_DELIVERYPUSH_PERFORMANCEIMPROVEMENTENDDATE=${PerformanceImprovementEndDate}'
        ContainerSecret1: !Sub 'PN_DELIVERYPUSH_ADDRESSMANAGERAPIKEY=arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:pn-DeliveryPush-Secrets:AddressManagerApiKey:AWSCURRENT:'
        MicroServiceSecretPrefix: pn-DeliveryPush-Secrets
        JavaToolOptions: '-Dreactor.netty.ioWorkerCount=50'
        MappedPaths: '/delivery-push/*,/delivery-push-private/*,/delivery-progresses/*'
        ECSClusterName: !Ref ECSClusterName
        Subnets: !Join [ ',', !Ref SubnetsIds ]
        VpcId: !Ref VpcId
        EcsDefaultSecurityGroup: !Ref EcsDefaultSecurityGroup
        LoadBalancerListenerArn: !Ref ApplicationLoadBalancerListenerArn
        LoadbalancerRulePriority: !Ref MicroserviceNumber
        TaskRoleManagedPolicyArn: !Ref DeliveryPushMicroserviceTaskManagedPolicy
        AlbSecurityGroup: !Ref AlbSecurityGroup
        EcsLogGroup: !Ref EcsLogGroup
        LogAlarmStrategyV1: !Ref LogAlarmStrategy

  # Grant operational rights to PN-Delivery-push microservice microservice
  DeliveryPushMicroserviceTaskManagedPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - sqs:ChangeMessageVisibility
              - sqs:ChangeMessageVisibilityBatch
              - sqs:DeleteMessage
              - sqs:DeleteMessageBatch
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:ReceiveMessage
              - sqs:SendMessage
              - sqs:SendMessageBatch
            Resource:
              - !Ref DeliveryPushInputsQueueARN
              - !Ref DeliveryPushValidationInputsQueueARN
              - !Ref ExternalChannelsOutputsQueueARN
              - !Ref ScheduledActionsQueueARN
              - !Ref ScheduledValidationActionsQueueARN
              - !Ref DoneActionsQueueARN
              - !Ref SafeStorageToDeliveryPushQueueARN
              - !Ref NationalRegistries2DeliveryPushQueueARN
              - !Ref AddressManagerToDeliveryPushQueueARN
              - !Ref F24ToDeliveryPushQueueARN
          - Effect: Allow
            Action:
              - 'dynamodb:GetItem'
              - 'dynamodb:Query'
              - 'dynamodb:PutItem'
            Resource:
              - !Sub "${TimelinesDynamoTableArn}"
              - !Sub "${ActionDynamoTableArn}"
          - Effect: Allow
            Action:
              - dynamodb:GetItem
              - dynamodb:PutItem
              - dynamodb:DeleteItem
              - dynamodb:UpdateItem
            Resource:
              - !Sub "${TimelinesCounterTableArn}"
          - Effect: Allow
            Action:
              - 'ssm:GetParameter'
              - 'ssm:GetParameters'
            Resource:
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/MapPaMVP'
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/MapPaSendMoreThan20Grams'
          - Effect: Allow
            Action:
              - 'dynamodb:GetItem'
              - 'dynamodb:Query'
              - 'dynamodb:PutItem'
              - 'dynamodb:DeleteItem'
              - 'dynamodb:UpdateItem'
            Resource:
              - !Sub "${PaperNotificationFailedDynamoTableArn}"
              - !Sub "${FutureActionDynamoTableArn}"
              - !Sub "${LastPollForFutureActionDynamoTableArn}"
              - !Sub "${PnDeliveryPushShedLockDynamoTableArn}"
              - !Sub "${PnDeliveryPushWebhookStreamsTableArn}"
              - !Sub "${PnDeliveryPushWebhookEventsTableArn}"
              - !Sub "${DocumentCreationRequestTableArn}"
  
  # Expose PN-Delivery-push microservice public API with API-GW for B2B usage
  DeliveryPushMicroservicePublicAPI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/api-gw-expose-service-openapi.yaml"
      Parameters:
        MicroServiceUniqueName: !Sub '${ProjectName}-delivery-push'
        IntendedUsage: B2B
        DnsName: !Ref ApiDnsName
        ProjectName: !Ref ProjectName
        ServiceApiPath: 'delivery-push'
        NetworkLoadBalancerLink: !Ref NetworkLoadBalancerLink
        ApplicationLoadBalancerDomain: !Ref ApplicationLoadBalancerDomain
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        CloudwatchLogKinesisStreamArn: !Ref LogsKinesisSourceStreamArn
        OpenApiBucketName: !Ref MicroserviceBucketName
        OpenApiBucketKey: !Sub ${MicroserviceBucketBaseKey}/docs/openapi/aws/api-delivery-push-B2B-aws.yaml

  DeliveryPushMicroservicePublicApiWaf:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/api-gw-waf-acl.yaml"
      Parameters:
        WAFName: !Sub '${ProjectName}-delivery-push-b2b'
        IntendedUsage: B2B 
        APIGatewayARNs: !GetAtt DeliveryPushMicroservicePublicAPI.Outputs.APIGatewayARN
        Limit: !Ref B2bWafLimit

  # Expose PN-Delivery-progress microservice public API with API-GW for B2B usage
  DeliveryProgressMicroservicePublicAPI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/api-gw-expose-service-openapi.yaml"
      Parameters:
        MicroServiceUniqueName: !Sub '${ProjectName}-delivery-progress'
        IntendedUsage: B2B
        DnsName: !Ref ApiDnsName
        ProjectName: !Ref ProjectName
        ServiceApiPath: 'delivery-progresses'
        NetworkLoadBalancerLink: !Ref NetworkLoadBalancerLink
        ApplicationLoadBalancerDomain: !Ref ApplicationLoadBalancerDomain
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        CloudwatchLogKinesisStreamArn: !Ref LogsKinesisSourceStreamArn
        OpenApiBucketName: !Ref MicroserviceBucketName
        OpenApiBucketKey: !Sub ${MicroserviceBucketBaseKey}/docs/openapi/aws/api-delivery-progresses-B2B-aws.yaml

  DeliveryProgressMicroservicePublicApiWaf:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/api-gw-waf-acl.yaml"
      Parameters:
        WAFName: !Sub '${ProjectName}-delivery-progress-b2b'
        IntendedUsage: B2B 
        APIGatewayARNs: !GetAtt DeliveryProgressMicroservicePublicAPI.Outputs.APIGatewayARN
        Limit: 600000

  # Expose PN-Delivery-push microservice public API with API-GW for WEB usage
  DeliveryPushMicroservicePublicWebAPI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/api-gw-expose-service-openapi.yaml"
      Parameters:
        MicroServiceUniqueName: !Sub '${ProjectName}-delivery-push'
        IntendedUsage: WEB
        DnsName: !Ref WebApiDnsName
        ProjectName: !Ref ProjectName
        ServiceApiPath: 'delivery-push'
        NetworkLoadBalancerLink: !Ref NetworkLoadBalancerLink
        ApplicationLoadBalancerDomain: !Ref ApplicationLoadBalancerDomain
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        CloudwatchLogKinesisStreamArn: !Ref LogsKinesisSourceStreamArn  
        OpenApiBucketName: !Ref MicroserviceBucketName
        OpenApiBucketKey: !Sub ${MicroserviceBucketBaseKey}/docs/openapi/aws/api-delivery-push-WEB-aws.yaml

  DeliveryPushMicroservicePublicWebApiWaf:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/api-gw-waf-acl.yaml"
      Parameters:
        WAFName: !Sub '${ProjectName}-delivery--push-web'
        IntendedUsage: WEB 
        APIGatewayARNs: !GetAtt DeliveryPushMicroservicePublicWebAPI.Outputs.APIGatewayARN
        Limit: !Ref WebWafLimit
        EnhancedWebSecurityEnabled: !Ref EnhancedWebSecurityEnabled

  #########################################################
  ###              WebhookEventManagerLambda            ###
  #########################################################

  # Lambda function
  WebhookEventManagerLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Ref WebhookEventManagerLambdaName
      Runtime: nodejs18.x
      Handler: "index.handler"
      Code:
        S3Bucket: !Ref MicroserviceBucketName
        S3Key: !Sub "${MicroserviceBucketBaseKey}/functions_zip/webhookEventManager.zip"
      Role: !GetAtt WebhookEventManagerLambdaRole.Arn
      Environment:
        Variables:
          REGION: !Sub ${AWS::Region}
          QUEUE_URL: !Ref DoneActionsQueueURL
      TracingConfig:
        Mode: Active
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:339249233099:layer:LambdaInsightsExtension:13"
      Timeout: 10

  # Lambda function role
  WebhookEventManagerLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-webhookEventManagerLambdaRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  # Lambda function IAM policy
  WebhookEventManagerLambdaPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub ${ProjectName}-WebhookEventManagerLambdaPolicy
      Roles:
        - !Ref WebhookEventManagerLambdaRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - kinesis:DescribeStream
              - kinesis:DescribeStreamSummary
              - kinesis:GetShardIterator
              - kinesis:GetRecords
              - kinesis:ListShards
              - kinesis:ListStreams
              - kinesis:SubscribeToShard
            Resource: !Ref CdcKinesisSourceStreamArn
          - Action: kms:Decrypt
            Effect: Allow
            Resource: !Ref CdcKinesisSourceStreamKeyArn
          - Effect: Allow
            Action:
              - sqs:ChangeMessageVisibility
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:SendMessage
            Resource:
              !Ref DoneActionsQueueARN
          - Effect: Allow
            Action:
              - sqs:ChangeMessageVisibility
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:SendMessage
            Resource:
              !Ref WebhookEventManagerDLQARN


  # CDC to Webhook Event Manager
  WebhookEventManagerLambdaKinesisSource:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      BatchSize: !Sub ${WebhookEventManagerLambdaBatchSize}
      BisectBatchOnFunctionError: true
      EventSourceArn: !Ref CdcKinesisSourceStreamArn
      FunctionName: !Ref WebhookEventManagerLambda
      FunctionResponseTypes:
        - ReportBatchItemFailures
      MaximumBatchingWindowInSeconds: !Sub ${WebhookEventManagerLambdaMaximumBatchingWindowInSeconds}
      StartingPosition: TRIM_HORIZON
      DestinationConfig:
        OnFailure:
          Destination: !Ref WebhookEventManagerDLQARN

  WebhookEventManagerLambdaAlarms:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/lambda-alarms.yaml"
      Parameters:
        FunctionName: !Ref WebhookEventManagerLambda
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
  
  # CDC to Lambda action router
  ActionRouterKinesisSource:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      BatchSize: !Ref ActionRouterKinesisBatchSize
      BisectBatchOnFunctionError: true
      EventSourceArn: !Ref CdcPnActionArn
      FunctionName: !Ref ActionRouterLambda
      DestinationConfig:
        OnFailure:
          Destination: !Ref ActionRouterDLQARN
      FunctionResponseTypes:
        - ReportBatchItemFailures
      FilterCriteria:
        { "Filters": [ { "Pattern": '{"data": {"eventName": ["INSERT"]}}' } ] }
      MaximumBatchingWindowInSeconds: 300
      MaximumRetryAttempts: 5
      StartingPosition: TRIM_HORIZON

  ActionRouterLambdaLibrariesLayer:
    Type: AWS::Lambda::LayerVersion
    Properties:
      CompatibleRuntimes:
        - nodejs18.x
      Content:
        S3Bucket: !Ref MicroserviceBucketName
        S3Key: !Sub "${MicroserviceBucketBaseKey}/functions_zip/pn-action-router_libs.zip"
      Description: NodeJs Libs layer
      LayerName: actionRouterLambda-libs-layer

  ActionRouterLambda:
    Type: AWS::CloudFormation::Stack
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/lambda.yaml"
      Parameters:
        FunctionName: !Ref ActionRouterLambdaName
        Handler: "index.handler"
        FunctionBucketName: !Ref MicroserviceBucketName
        FunctionBucketKey: !Sub "${MicroserviceBucketBaseKey}/functions_zip/pn-action-router.zip"
        MemorySize: 512
        Timeout: 10
        Runtime: nodejs18.x
        RoleArn: !GetAtt ActionRouterLambdaRole.Arn
        Layer1: !Ref ActionRouterLambdaLibrariesLayer
        EnvVariables:
          !Sub [
            "ACTION_QUEUE_MAP=${actionQueueMap},QUEUE_URL_MAP=${QueueUrlMap}",
            {
              actionQueueMap: !Ref ActionQueueMap,
              QueueUrlMap: !Ref QueueUrlMap 
            },
          ]
        #TODO Valutare la necessità di inserire la VPC
  
  # Lambda function role
  ActionRouterLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-actionRouterLambdaRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  # Lambda function IAM policy
  ActionRouterLambdaPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub ${ProjectName}-ActionRouterLambdaPolicy
      Roles:
        - !Ref ActionRouterLambdaRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - kinesis:DescribeStream
              - kinesis:DescribeStreamSummary
              - kinesis:GetShardIterator
              - kinesis:GetRecords
              - kinesis:ListShards
              - kinesis:ListStreams
              - kinesis:SubscribeToShard
            Resource: !Ref CdCPnActionArn
          - Effect: "Allow"
            Action:
              - "logs:CreateLogGroup"
              - "logs:CreateLogStream"
              - "logs:PutLogEvents"
            Resource: "*"
          - Effect: Allow 
            Action:
              - sqs:SendMessage
            Resource:
              - !Ref ScheduledActionsQueueARN
              - !Ref ScheduledValidationActionsQueueARN
              - !Ref ActionRouterDLQARN
          - Effect: Allow
            Action:
              - "dynamodb:PutItem"
              - "dynamodb:BatchWriteItem"
            Resource:
              - !Ref FutureActionDynamoTableArn

  # Expose PN-Delivery-push microservice public API with API-GW for IO usage
  DeliveryPushMicroservicePublicIoAPI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/api-gw-expose-service-openapi.yaml"
      Parameters:
        MicroServiceUniqueName: !Sub '${ProjectName}-delivery-push'
        IntendedUsage: IO
        DnsName: !Ref IoApiDnsName
        ProjectName: !Ref ProjectName
        ServiceApiPath: 'delivery-push'
        NetworkLoadBalancerLink: !Ref NetworkLoadBalancerLink
        ApplicationLoadBalancerDomain: !Ref ApplicationLoadBalancerDomain
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        CloudwatchLogKinesisStreamArn: !Ref LogsKinesisSourceStreamArn        
        OpenApiBucketName: !Ref MicroserviceBucketName
        OpenApiBucketKey: !Sub ${MicroserviceBucketBaseKey}/docs/openapi/aws/api-delivery-push-IO-aws.yaml

  DeliveryPushMicroservicePublicIoApiWaf:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/api-gw-waf-acl.yaml"
      Parameters:
        WAFName: !Sub '${ProjectName}-delivery-push-io'
        IntendedUsage: IO 
        APIGatewayARNs: !GetAtt DeliveryPushMicroservicePublicIoAPI.Outputs.APIGatewayARN
        Limit: 0 # disabled IP based rate limit rule
        AllowedCidrs: !Ref IOBackendCidrs

  ##########################################################################
  ###              notificationCancellationActionInsertLambda            ###
  ##########################################################################

  # Lambda function
  NotificationCancellationActionInsertLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Ref NotificationCancellationActionInsertLambdaName
      Runtime: nodejs18.x
      Handler: "index.handler"
      Code:
        S3Bucket: !Ref MicroserviceBucketName
        S3Key: !Sub "${MicroserviceBucketBaseKey}/functions_zip/notificationCancellationActionInsert.zip"
      Role: !GetAtt   NotificationCancellationActionInsertLambdaRole.Arn
      Environment:
        Variables:
          REGION: !Sub ${AWS::Region}
          ACTION_TTL_DAYS: !Ref ActionTtlDays
      TracingConfig:
        Mode: Active
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:339249233099:layer:LambdaInsightsExtension:13"
      Timeout: 10

  # Lambda function role
  NotificationCancellationActionInsertLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-notificationCancellationActionInsertLambdaRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  # Lambda function IAM policy
  NotificationCancellationActionInsertLambdaPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub ${ProjectName}-NotificationCancellationActionInsertLambdaPolicy
      Roles:
        - !Ref NotificationCancellationActionInsertLambdaRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - "dynamodb:TransactWriteItems"
              - "dynamodb:PutItem"
            Resource:
              - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/pn-Action
              - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/pn-Action/*"
          - Effect: Allow
            Action:
              - "dynamodb:TransactWriteItems"
              - "dynamodb:PutItem"
            Resource:
              - !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/pn-FutureAction
              - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/pn-FutureAction/*"
          - Effect: Allow
            Action:
              - kinesis:DescribeStream
              - kinesis:DescribeStreamSummary
              - kinesis:GetShardIterator
              - kinesis:GetRecords
              - kinesis:ListShards
              - kinesis:ListStreams
              - kinesis:SubscribeToShard
            Resource: !Ref CdcKinesisSourceStreamArn
          - Action: kms:Decrypt
            Effect: Allow
            Resource: !Ref CdcKinesisSourceStreamKeyArn
          - Effect: Allow
            Action:
              - sqs:ChangeMessageVisibility
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:SendMessage
            Resource: !Ref NotificationCancellationActionInsertDLQARN

  # CDC to NotificationCancellationActionInsert
  NotificationCancellationActionInsertLambdaSource:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      BatchSize: !Sub ${NotificationCancellationActionInsertLambdaBatchSize}
      BisectBatchOnFunctionError: true
      EventSourceArn: !Ref CdcKinesisSourceStreamArn
      FunctionName: !Ref NotificationCancellationActionInsertLambda
      FunctionResponseTypes:
        - ReportBatchItemFailures
      MaximumBatchingWindowInSeconds: !Sub ${NotificationCancellationActionInsertLambdaMaximumBatchingWindowInSeconds}
      StartingPosition: TRIM_HORIZON
      DestinationConfig:
        OnFailure:
          Destination: !Ref NotificationCancellationActionInsertDLQARN

  NotificationCancellationActionInsertLambdaAlarms:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/lambda-alarms.yaml"
      Parameters:
        FunctionName: !Ref NotificationCancellationActionInsertLambda
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn

  #########################################################
  ###             PaperEventsCostUpdateLambda           ###
  #########################################################

  # Lambda function
  PaperEventsCostUpdateLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Ref PaperEventsCostUpdateLambdaName
      Runtime: nodejs18.x
      Handler: "index.handler"
      Code:
        S3Bucket: !Ref MicroserviceBucketName
        S3Key: !Sub "${MicroserviceBucketBaseKey}/functions_zip/paperEventsCostUpdate.zip"
      Role: !GetAtt PaperEventsCostUpdateLambdaRole.Arn
      Environment:
        Variables:
          REGION: !Sub ${AWS::Region}
          QUEUE_URL: !Ref DeliveryPushToExternalRegistriesQueueURL
      TracingConfig:
        Mode: Active
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:339249233099:layer:LambdaInsightsExtension:13"
      Timeout: 10

  # Lambda function role
  PaperEventsCostUpdateLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-paperEventsCostUpdateLambdaRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  # Lambda function IAM policy
  PaperEventsCostUpdateLambdaPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub ${ProjectName}-PaperEventsCostUpdateLambdaPolicy
      Roles:
        - !Ref PaperEventsCostUpdateLambdaRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - kinesis:DescribeStream
              - kinesis:DescribeStreamSummary
              - kinesis:GetShardIterator
              - kinesis:GetRecords
              - kinesis:ListShards
              - kinesis:ListStreams
              - kinesis:SubscribeToShard
            Resource: !Ref CdcKinesisSourceStreamArn
          - Action: kms:Decrypt
            Effect: Allow
            Resource: !Ref CdcKinesisSourceStreamKeyArn
          - Effect: Allow
            Action:
              - sqs:ChangeMessageVisibility
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:SendMessage
            Resource:
              !Ref DeliveryPushToExternalRegistriesQueueARN
          - Effect: Allow
            Action:
              - sqs:ChangeMessageVisibility
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:SendMessage
            Resource:
              !Ref PaperEventsCostUpdateDLQARN

    # CDC to Paper Events Cost Update
  PaperEventsCostUpdateLambdaKinesisSource:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      BatchSize: !Sub ${PaperEventsCostUpdateLambdaBatchSize}
      BisectBatchOnFunctionError: true
      EventSourceArn: !Ref CdcKinesisSourceStreamArn
      FunctionName: !Ref PaperEventsCostUpdateLambda
      FunctionResponseTypes:
        - ReportBatchItemFailures
      MaximumBatchingWindowInSeconds: !Sub ${PaperEventsCostUpdateLambdaMaximumBatchingWindowInSeconds}
      StartingPosition: TRIM_HORIZON
      DestinationConfig:
        OnFailure:
          Destination: !Ref PaperEventsCostUpdateDLQARN

  PaperEventsCostUpdateLambdaAlarms:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/lambda-alarms.yaml"
      Parameters:
        FunctionName: !Ref PaperEventsCostUpdateLambda
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
  
  # TODO Da eliminare tutta la regola, aggiungere dynque coda DeliveryPushValidationInputsQueueARN alla regola in pn-infra
  # Allow event bus rules to write to queues
  EventBusEnqueueRole:
    Condition: IsEnvironmentDev
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
        Version: "2012-10-17"
      Policies:
        - PolicyName: putEventIntoQueues
          PolicyDocument:
            Statement:
              - Sid: putEvents
                Action:
                  - sqs:ChangeMessageVisibility
                  - sqs:ChangeMessageVisibilityBatch
                  - sqs:GetQueueAttributes
                  - sqs:GetQueueUrl
                  - sqs:SendMessage
                  - sqs:SendMessageBatch
                Effect: Allow
                Resource:
                  - !Ref DeliveryPushValidationInputsQueueARN
      Tags:
        - Key: Microservice
          Value: pn-infra-core

  # TODO Da spostare in pn-infra
  # New notification message rule from delivery to delivery-push
  PnCoreEventBusDeliveryToDeliveryPushValidationQueue:
    Condition: IsEnvironmentDev
    Type: AWS::Events::Rule
    Properties:
      Description: New notification message rule from delivery to delivery-push
      RoleArn: !GetAtt "EventBusEnqueueRole.Arn"
      EventBusName: !Sub '${ProjectName}-CoreEventBus' #Al momento non si ha la possibilità di ricevere il nome come parametro di input
      EventPattern:
        detail-type: [ "PnDeliveryValidationOutcomeEvent" ]
        detail:
          cxId: [ "pn-delivery-push" ]
      Targets:
# TODO Da riattivare quando regola viene spostata in Infra
#        - Arn: !GetAtt MatchedEventsLoggerFunction.Arn
#          Id: !Sub ${ProjectName}-Logger-AddressManager2DeliveryPush
#          InputTransformer:
#            InputPathsMap:
#              "timestamp": "$.time"
#            InputTemplate: |
#              {
#                  "timestamp": <timestamp>,
#                  "ruleArn": <aws.events.rule-arn>,
#                  "ruleName": <aws.events.rule-name>,
#                  "ingestionTime": <aws.events.event.ingestion-time>,
#                  "originalEvent": <aws.events.event.json>
#              }       
        - Id: !Sub '${ProjectName}-CoreEventBus-Delivery2DeliveryPush-Validation'
          Arn: !Ref ValidationMessageEventBridgeToQueueLambda
#          DeadLetterConfig:   # TODO Da decommentare in pn-infra
#            Arn: !GetAtt EventBusDeadLetterQueue.Arn  
  
  # TODO Da spostare in pn-infra
  ValidationMessageEventBridgeToQueueLambdaLibrariesLayer:
    Condition: IsEnvironmentDev
    Type: AWS::Lambda::LayerVersion
    Properties:
      CompatibleRuntimes:
        - nodejs18.x
      Content:
        S3Bucket: !Ref MicroserviceBucketName
        S3Key: !Sub "${MicroserviceBucketBaseKey}/functions_zip/validation-message-eventBridge-to-queue_libs.zip"
      Description: NodeJs Libs layer
      LayerName: ValidationMessageEventBridgeToQueue-libs-layer
  
  # TODO Da spostare in pn-infra
  # Lambda validation message from delivery (eventBridge) to delivery-push validation queue message
  ValidationMessageEventBridgeToQueueLambda:
    Condition: IsEnvironmentDev
    Type: AWS::CloudFormation::Stack
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/lambda.yaml"
      Parameters:
        FunctionName: !Ref ValidationMessageEventBridgeToQueueLambdaName
        Handler: "index.handler"
        FunctionBucketName: !Ref MicroserviceBucketName
        FunctionBucketKey: !Sub "${MicroserviceBucketBaseKey}/functions_zip/validation-message-eventBridge-to-queue.zip"
        MemorySize: 512
        Timeout: 10
        Runtime: nodejs18.x
        TracingConfigMode: "Active"
        Role: !GetAtt ValidationMessageEventBridgeToQueueRole.Arn
        Layer1: !Ref ValidationMessageEventBridgeToQueueLambdaLibrariesLayer
        EnvVariables:          
            !Sub [
              "DESTINATION_ENDPOINT=${url}",
              { url: !Ref DeliveryPushValidationInputsQueueURL },
            ]

  # TODO Da spostare in pn-infra
  # Lambda function role
  ValidationMessageEventBridgeToQueueRole:
    Condition: IsEnvironmentDev
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-validationMessageEventBridgeToQueueRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
  
  # TODO Da spostare in pn-infra
  # Lambda function IAM policy
  ValidationMessageEventBridgeToQueuePolicy:
    Condition: IsEnvironmentDev
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub ${ProjectName}-validationMessageEventBridgeToQueuePolicy
      Roles:
        - !Ref ValidationMessageEventBridgeToQueueRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: "Allow"
            Action:
              - "logs:CreateLogGroup"
              - "logs:CreateLogStream"
              - "logs:PutLogEvents"
            Resource: "*"
          - Effect: Allow
            Action:
              - sqs:SendMessage
            Resource:
              - !Ref DeliveryPushValidationInputsQueueARN

  #########################################################
  ###              VersioningV1V2Webhook              ### # converte la risposta V2.3 a V1 e può essere estesa
  #########################################################
  VersioningV1V2WebhookSecGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub '${VersioningV1V2WebhookLambdaName}-sec-group'
      VpcId: !Ref VpcId

  # Lambda function
  VersioningV1V2WebhookLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Ref VersioningV1V2WebhookLambdaName
      Runtime: nodejs18.x
      Handler: "index.handler"
      Code:
        S3Bucket: !Ref MicroserviceBucketName
        S3Key: !Sub "${MicroserviceBucketBaseKey}/functions_zip/versioningV1V2Webhook.zip"
      Role: !GetAtt VersioningV1V2WebhookLambdaRole.Arn
      VpcConfig:
        SecurityGroupIds:
          - !GetAtt VersioningV1V2WebhookSecGroup.GroupId
        SubnetIds: !Ref SubnetsIds
      Environment:
        Variables:
          REGION: !Sub ${AWS::Region}
          PN_WEBHOOK_URL: !Sub "http://${ApplicationLoadBalancerDomain}:8080/delivery-progresses/v2.3"
      TracingConfig:
        Mode: Active
      Layers:
        - !Sub "arn:aws:lambda:${AWS::Region}:339249233099:layer:LambdaInsightsExtension:13"
      Timeout: 10
      MemorySize: 512
      Tags:
        - Key: "pn-eni-related"
          Value: "true"
        - Key: "pn-eni-related-groupName-regexp"
          Value: !Base64 "^pn-delivery-microsvc-prod-VersioningV1V2WebhookSecGroup*$"

  # a new version at each deploy, with provisioned concurrency set
  # remember to set transform -> UpdateDeploymentTransform at beginning of the file
  VersioningV1V2WebhookLambdaVersionPnPlaceholderEpochSeconds:
    Type: AWS::Lambda::Version
    Properties:
      FunctionName: !Ref VersioningV1V2WebhookLambda

  VersioningV1V2WebhookLambdaVersionAlias:
    Type: AWS::Lambda::Alias
    Properties: 
      FunctionName: !Ref VersioningV1V2WebhookLambda
      FunctionVersion: !GetAtt VersioningV1V2WebhookLambdaVersionPnPlaceholderEpochSeconds.Version
      Name: live
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: !Ref VersioningV1V2WebhookLambdaProvisionedConcurrency

  # Lambda function role
  VersioningV1V2WebhookLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-VersioningV1V2WebhookLambdaRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
        # - arn:aws:iam::aws:policy/CloudWatchLambdaInsightsExecutionRolePolicy

  VersioningV1V2WebhookLambdaAlarms:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/lambda-alarms.yaml"
      Parameters:
        FunctionName: !Ref VersioningV1V2WebhookLambda
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        FilterPattern: "FATAL"

  # Lambda access right
  VersioningV1V2WebhookLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref VersioningV1V2WebhookLambdaVersionAlias
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:*/*'


  ## Dashboard
  DeliveryPushMicroserviceCloudWatchDashboard:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/microservice-cloudwatch-dashboard.yaml"
      Parameters:
        DashboardName: !Sub "${ProjectName}-delivery-push"
        DynamoDBTableNames: !Join 
          - ',' 
          - - !Ref TimelinesDynamoTableName
            - !Ref TimelinesCounterTableName
            - !Ref PaperNotificationFailedDynamoTableName
            - !Ref ActionDynamoTableName
            - !Ref FutureActionDynamoTableName
            - !Ref LastPollForFutureActionDynamoTableName
            - !Ref PnDeliveryPushShedLockDynamoTableName
            - !Ref PnDeliveryPushWebhookStreamsTableName
            - !Ref PnDeliveryPushWebhookEventsTableName
            - !Ref DocumentCreationRequestTableName 
        RestApiStageArns: !Join
          - ','
          - - !GetAtt DeliveryPushMicroservicePublicAPI.Outputs.RestApiStageArn
            - !GetAtt DeliveryProgressMicroservicePublicAPI.Outputs.RestApiStageArn
            - !GetAtt DeliveryPushMicroservicePublicWebAPI.Outputs.RestApiStageArn
            - !GetAtt DeliveryPushMicroservicePublicIoAPI.Outputs.RestApiStageArn
        RestApiNames: !Join
          - ','
          - - !GetAtt DeliveryPushMicroservicePublicAPI.Outputs.RestApiName
            - !GetAtt DeliveryProgressMicroservicePublicAPI.Outputs.RestApiName
            - !GetAtt DeliveryPushMicroservicePublicWebAPI.Outputs.RestApiName
            - !GetAtt DeliveryPushMicroservicePublicIoAPI.Outputs.RestApiName
        AlarmArns: !Join
          - ','
          - - !GetAtt DeliveryPushMicroservice.Outputs.FatalLogsMetricAlarmArn
            - !Ref DeliveryPushInputsQueueAlarmARN
            - !Ref DeliveryPushInputsQueueAgeAlarmARN
            - !Ref DeliveryPushValidationInputsQueueAlarmARN
            - !Ref DeliveryPushValidationInputsQueueAgeAlarmARN
            - !Ref SafeStorageToDeliveryPushQueueAlarmARN
            - !Ref SafeStorageToDeliveryPushQueueAgeAlarmARN
            - !Ref DoneActionsQueueAlarmARN
            - !Ref DoneActionsQueueAgeAlarmARN
            - !Ref ScheduledActionsQueueAlarmARN
            - !Ref ScheduledActionsQueueAgeAlarmARN
            - !Ref ScheduledValidationActionsQueueAlarmARN
            - !Ref ScheduledValidationActionsQueueAgeAlarmARN
            - !Ref NationalRegistries2DeliveryPushQueueAlarmARN
            - !Ref NationalRegistries2DeliveryPushQueueAgeAlarmARN
            - !Ref AddressManagerToDeliveryPushQueueAlarmARN
            - !Ref F24ToDeliveryPushQueueAlarmARN
            - !Ref AddressManagerToDeliveryPushQueueAgeAlarmARN
            - !Ref F24ToDeliveryPushQueueAgeAlarmARN
            - !Ref NotificationCancellationActionInsertDLQAlarmARN
            - !GetAtt NotificationCancellationActionInsertLambdaAlarms.Outputs.LambdaInvocationErrorLogsMetricAlarm
            - !Ref WebhookEventManagerDLQAlarmARN
            - !GetAtt WebhookEventManagerLambdaAlarms.Outputs.LambdaInvocationErrorLogsMetricAlarm
            - !Ref PaperEventsCostUpdateDLQAlarmARN
            - !Ref ActionRouterDLQAlarmARN
            - !Ref ActionEnqueuerDLQAlarmARN
            - !GetAtt PaperEventsCostUpdateLambdaAlarms.Outputs.LambdaInvocationErrorLogsMetricAlarm
            - !GetAtt VersioningV1V2WebhookLambdaAlarms.Outputs.LambdaInvocationErrorLogsMetricAlarm
        LambdaArns: !Join
          - ","
          - - !GetAtt NotificationCancellationActionInsertLambda.Arn
            - !GetAtt WebhookEventManagerLambda.Arn
            - !GetAtt PaperEventsCostUpdateLambda.Arn
            - !GetAtt VersioningV1V2WebhookLambda.Arn
        QueueArns: !Join
          - ','
          - - !Ref DeliveryPushInputsQueueARN
            - !Ref DeliveryPushValidationInputsQueueARN
            - !Ref ExternalChannelsOutputsQueueARN
            - !Ref ScheduledActionsQueueARN
            - !Ref ScheduledValidationActionsQueueARN
            - !Ref DoneActionsQueueARN
            - !Ref SafeStorageToDeliveryPushQueueARN
            - !Ref NationalRegistries2DeliveryPushQueueARN
            - !Ref AddressManagerToDeliveryPushQueueARN
            - !Ref F24ToDeliveryPushQueueARN
        LogGroupsNames: !Join
          - ','
          - - !Sub '/aws/ecs/${ProjectName}-delivery-push'
            - !Sub '/aws/lambda/${NotificationCancellationActionInsertLambdaName}'
            - !Sub '/aws/lambda/${WebhookEventManagerLambdaName}'
            - !Sub '/aws/lambda/${PaperEventsCostUpdateLambdaName}'
            - !Sub '/aws/lambda/${VersioningV1V2WebhookLambdaName}'

  #### Alarm for custom metric Autoscaling
  AlarmCustomAutoscaling:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      AlarmName: !Sub "${ProjectName}-delivery-push-autoscaling-custom"
      AlarmDescription: "Trigger scaling based on custom metric"
      DatapointsToAlarm: !Ref AutoscalingDataPointN
      ComparisonOperator: "GreaterThanOrEqualToThreshold"
      Metrics:
        - Id: m1
          MetricStat:
            Metric:
              Dimensions:
                - Name: QueueName
                  Value: !Ref "AddressManagerToDeliveryPushQueueName"
              Namespace: "AWS/SQS"
              MetricName: "ApproximateNumberOfMessagesVisible"
            Period: !Ref AutoscalingCheckPeriod
            Stat: Average
          ReturnData: False
        - Id: m2
          MetricStat:
            Metric:
              Dimensions:
                - Name: QueueName
                  Value: !Ref "DeliveryPushInputsQueueName"
              Namespace: "AWS/SQS"
              MetricName: "ApproximateNumberOfMessagesVisible"
            Period: !Ref AutoscalingCheckPeriod
            Stat: Average
          ReturnData: False
        - Id: m3
          MetricStat:
            Metric:
              Dimensions:
                - Name: QueueName
                  Value: !Ref "ExternalChannelsOutputsQueueName"
              Namespace: "AWS/SQS"
              MetricName: "ApproximateNumberOfMessagesVisible"
            Period: !Ref AutoscalingCheckPeriod
            Stat: Average
          ReturnData: False          
        - Id: m4
          MetricStat:
            Metric:
              Dimensions:
                - Name: QueueName
                  Value: !Ref "NationalRegistries2DeliveryPushQueueName"
              Namespace: "AWS/SQS"
              MetricName: "ApproximateNumberOfMessagesVisible"
            Period: !Ref AutoscalingCheckPeriod
            Stat: Average
          ReturnData: False          
        - Id: m5
          MetricStat:
            Metric:
              Dimensions:
                - Name: QueueName
                  Value: !Ref "SafeStorageToDeliveryPushQueueName"
              Namespace: "AWS/SQS"
              MetricName: "ApproximateNumberOfMessagesVisible"
            Period: !Ref AutoscalingCheckPeriod
            Stat: Average
          ReturnData: False                    
        - Id: m6
          MetricStat:
            Metric:
              Dimensions:
                - Name: QueueName
                  Value: !Ref "ScheduledActionsQueueName"
              Namespace: "AWS/SQS"
              MetricName: "ApproximateNumberOfMessagesVisible"
            Period: !Ref AutoscalingCheckPeriod
            Stat: Average
          ReturnData: False       
        - Id: m7
          MetricStat:
            Metric:
              Dimensions:
                - Name: TargetGroup
                  Value: !GetAtt DeliveryPushMicroservice.Outputs.TargetGroupName
              Namespace: "AWS/ApplicationELB"
              MetricName: "RequestCountPerTarget"
            Period: !Ref AutoscalingCheckPeriod
            Stat: Sum
          ReturnData: False                                        
        - Id: m8
          MetricStat:
            Metric:
              Dimensions:
                - Name: TargetGroup
                  Value: !GetAtt DeliveryPushMicroservice.Outputs.TargetGroupName
                - Name: LoadBalancer
                  Value: !Ref ApplicationLoadBalancerMetricsDimensionName
              Namespace: "AWS/ApplicationELB"
              MetricName: "HealthyHostCount"
            Period: !Ref AutoscalingCheckPeriod
            Stat: Average
          ReturnData: False
        - Id: m9
          MetricStat:
            Metric:
              Dimensions:
                - Name: QueueName
                  Value: !Ref "F24ToDeliveryPushQueueName"
              Namespace: "AWS/SQS"
              MetricName: "ApproximateNumberOfMessagesVisible"
            Period: !Ref AutoscalingCheckPeriod
            Stat: Average
          ReturnData: False        
        - Id: code
          Expression: !Sub "IF(m8==0, 101, (100*(m1+m2+m3+m4+m5+m6)) / (${ConsumedQueueMessagePerMinute} * m8) )"
          Label: !Sub "${ProjectName}-delivery-push-queue-custom-metric"
          ReturnData: False
        - Id: http
          Expression: !Sub "(100 * m7) / ${AutoscalingThreshold}"
          Label: !Sub "${ProjectName}-delivery-push-http-custom-metric"
          ReturnData: False
        - Id: e1
          Expression: "IF( code<http, http, code )"
          Label: !Sub "${ProjectName}-delivery-push-autoscale-custom-metric"
      EvaluationPeriods: !Ref AutoscalingDataPointM
      Threshold: 60
      AlarmActions:
        - !GetAtt DeliveryPushMicroservice.Outputs.ScaleUpPolicy
      OKActions:
        - !GetAtt DeliveryPushMicroservice.Outputs.ScaleDownPolicy

Outputs:

  # 
  Version:
    Value: !Ref Version

